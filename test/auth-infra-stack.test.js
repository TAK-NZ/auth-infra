import * as cdk from 'aws-cdk-lib';
import { Template, Match } from 'aws-cdk-lib/assertions';
import { AuthInfraStack } from '../lib/auth-infra-stack';
describe('AuthInfraStack', () => {
    let app;
    let stack;
    let template;
    beforeEach(() => {
        app = new cdk.App();
        // Set required context parameters
        app.node.setContext('authentikAdminUserEmail', 'admin@example.com');
        stack = new AuthInfraStack(app, 'TestStack', {
            stackName: 'test',
            envType: 'dev-test',
        });
        template = Template.fromStack(stack);
    });
    test('Stack creates successfully', () => {
        expect(stack).toBeDefined();
    });
    test('Contains Aurora PostgreSQL cluster', () => {
        template.hasResourceProperties('AWS::RDS::DBCluster', {
            Engine: 'aurora-postgresql',
            DatabaseName: 'authentik',
        });
    });
    test('Contains Redis replication group', () => {
        template.hasResourceProperties('AWS::ElastiCache::ReplicationGroup', {
            Engine: 'valkey',
            ReplicationGroupDescription: 'Valkey (Redis) cluster for Authentik',
        });
    });
    test('Contains EFS file system', () => {
        template.hasResourceProperties('AWS::EFS::FileSystem', {
            Encrypted: true,
        });
    });
    test('Contains Application Load Balancer', () => {
        template.hasResourceProperties('AWS::ElasticLoadBalancingV2::LoadBalancer', {
            Type: 'application',
            Scheme: 'internet-facing',
        });
    });
    test('Contains ECS Task Definitions', () => {
        template.hasResourceProperties('AWS::ECS::TaskDefinition', {
            RequiresCompatibilities: ['FARGATE'],
            NetworkMode: 'awsvpc',
        });
    });
    test('Contains Secrets Manager secrets', () => {
        template.hasResourceProperties('AWS::SecretsManager::Secret', {
            Description: Match.stringLikeRegexp('.*Authentik.*'),
        });
    });
    test('Contains security groups', () => {
        template.hasResourceProperties('AWS::EC2::SecurityGroup', {
            GroupDescription: Match.anyValue(),
        });
    });
    test('Contains IAM roles for ECS tasks', () => {
        template.hasResourceProperties('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [
                    {
                        Effect: 'Allow',
                        Principal: {
                            Service: 'ecs-tasks.amazonaws.com',
                        },
                        Action: 'sts:AssumeRole',
                    },
                ],
            },
        });
    });
    test('Contains CloudWatch log group', () => {
        template.hasResourceProperties('AWS::Logs::LogGroup', {
            RetentionInDays: 7,
        });
    });
    test('Stack has required parameters', () => {
        template.hasParameter('EnableExecute', {
            Type: 'String',
            AllowedValues: ['true', 'false'],
            Default: 'false',
        });
        template.hasParameter('AuthentikAdminUserEmail', {
            Type: 'String',
        });
        template.hasParameter('AuthentikLDAPBaseDN', {
            Type: 'String',
            Default: 'DC=example,DC=com',
        });
        template.hasParameter('IpAddressType', {
            Type: 'String',
            AllowedValues: ['ipv4', 'dualstack'],
            Default: 'dualstack',
        });
        // GitSha parameter was removed - now used directly from imports
        // SSLCertificateARN parameter was removed - now imported from base stack
        template.hasParameter('AuthentikAdminUserEmail', {
            Type: 'String',
            Description: 'E-Mail address for the Authentik akadmin user',
        });
    });
    test('Stack has required outputs', () => {
        // CDK generates unique output names with suffixes
        const templateObj = template.toJSON();
        const outputKeys = Object.keys(templateObj.Outputs || {});
        // Check for Authentik URL output (name starts with 'Authentik' but may have suffix)
        const authentikOutput = outputKeys.find(key => key.startsWith('Authentik') && !key.includes('LDAP'));
        expect(authentikOutput).toBeDefined();
        if (authentikOutput) {
            expect(templateObj.Outputs[authentikOutput]).toMatchObject({
                Description: 'HTTP(S) ALB endpoint for CNAME',
            });
        }
        // Check for LDAP Base DN output (name starts with 'Authentik' and includes 'LDAP')
        const ldapBaseDnOutput = outputKeys.find(key => key.startsWith('Authentik') && key.includes('LDAP'));
        expect(ldapBaseDnOutput).toBeDefined();
        if (ldapBaseDnOutput) {
            expect(templateObj.Outputs[ldapBaseDnOutput]).toMatchObject({
                Description: 'LDAP Base DN',
            });
        }
    });
    test('Stack has conditions', () => {
        template.hasCondition('CreateProdResources', {});
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1pbmZyYS1zdGFjay50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXV0aC1pbmZyYS1zdGFjay50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDekQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRXpELFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxHQUFZLENBQUM7SUFDakIsSUFBSSxLQUFxQixDQUFDO0lBQzFCLElBQUksUUFBa0IsQ0FBQztJQUV2QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLGtDQUFrQztRQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyx5QkFBeUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBRXBFLEtBQUssR0FBRyxJQUFJLGNBQWMsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFO1lBQzNDLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLE9BQU8sRUFBRSxVQUFVO1NBQ3BCLENBQUMsQ0FBQztRQUNILFFBQVEsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtRQUN0QyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO1FBQzlDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxxQkFBcUIsRUFBRTtZQUNwRCxNQUFNLEVBQUUsbUJBQW1CO1lBQzNCLFlB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UUFDdkMsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3JCLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7Z0JBQzFELFdBQVcsRUFBRSxjQUFjO2FBQzVCLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7UUFDaEMsUUFBUSxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IFRlbXBsYXRlLCBNYXRjaCB9IGZyb20gJ2F3cy1jZGstbGliL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgQXV0aEluZnJhU3RhY2sgfSBmcm9tICcuLi9saWIvYXV0aC1pbmZyYS1zdGFjayc7XG5cbmRlc2NyaWJlKCdBdXRoSW5mcmFTdGFjaycsICgpID0+IHtcbiAgbGV0IGFwcDogY2RrLkFwcDtcbiAgbGV0IHN0YWNrOiBBdXRoSW5mcmFTdGFjaztcbiAgbGV0IHRlbXBsYXRlOiBUZW1wbGF0ZTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICAgIC8vIFNldCByZXF1aXJlZCBjb250ZXh0IHBhcmFtZXRlcnNcbiAgICBhcHAubm9kZS5zZXRDb250ZXh0KCdhdXRoZW50aWtBZG1pblVzZXJFbWFpbCcsICdhZG1pbkBleGFtcGxlLmNvbScpO1xuICAgIFxuICAgIHN0YWNrID0gbmV3IEF1dGhJbmZyYVN0YWNrKGFwcCwgJ1Rlc3RTdGFjaycsIHtcbiAgICAgIHN0YWNrTmFtZTogJ3Rlc3QnLFxuICAgICAgZW52VHlwZTogJ2Rldi10ZXN0JyxcbiAgICB9KTtcbiAgICB0ZW1wbGF0ZSA9IFRlbXBsYXRlLmZyb21TdGFjayhzdGFjayk7XG4gIH0pO1xuXG4gIHRlc3QoJ1N0YWNrIGNyZWF0ZXMgc3VjY2Vzc2Z1bGx5JywgKCkgPT4ge1xuICAgIGV4cGVjdChzdGFjaykudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgdGVzdCgnQ29udGFpbnMgQXVyb3JhIFBvc3RncmVTUUwgY2x1c3RlcicsICgpID0+IHtcbiAgICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6UkRTOjpEQkNsdXN0ZXInLCB7XG4gICAgICBFbmdpbmU6ICdhdXJvcmEtcG9zdGdyZXNxbCcsXG4gICAgICBEYXRhYmFzZU5hbWU6ICdhdXRoZW50aWsnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdDb250YWlucyBSZWRpcyByZXBsaWNhdGlvbiBncm91cCcsICgpID0+IHtcbiAgICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6RWxhc3RpQ2FjaGU6OlJlcGxpY2F0aW9uR3JvdXAnLCB7XG4gICAgICBFbmdpbmU6ICd2YWxrZXknLFxuICAgICAgUmVwbGljYXRpb25Hcm91cERlc2NyaXB0aW9uOiAnVmFsa2V5IChSZWRpcykgY2x1c3RlciBmb3IgQXV0aGVudGlrJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnQ29udGFpbnMgRUZTIGZpbGUgc3lzdGVtJywgKCkgPT4ge1xuICAgIHRlbXBsYXRlLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpFRlM6OkZpbGVTeXN0ZW0nLCB7XG4gICAgICBFbmNyeXB0ZWQ6IHRydWUsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0NvbnRhaW5zIEFwcGxpY2F0aW9uIExvYWQgQmFsYW5jZXInLCAoKSA9PiB7XG4gICAgdGVtcGxhdGUuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkVsYXN0aWNMb2FkQmFsYW5jaW5nVjI6OkxvYWRCYWxhbmNlcicsIHtcbiAgICAgIFR5cGU6ICdhcHBsaWNhdGlvbicsXG4gICAgICBTY2hlbWU6ICdpbnRlcm5ldC1mYWNpbmcnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdDb250YWlucyBFQ1MgVGFzayBEZWZpbml0aW9ucycsICgpID0+IHtcbiAgICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6RUNTOjpUYXNrRGVmaW5pdGlvbicsIHtcbiAgICAgIFJlcXVpcmVzQ29tcGF0aWJpbGl0aWVzOiBbJ0ZBUkdBVEUnXSxcbiAgICAgIE5ldHdvcmtNb2RlOiAnYXdzdnBjJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnQ29udGFpbnMgU2VjcmV0cyBNYW5hZ2VyIHNlY3JldHMnLCAoKSA9PiB7XG4gICAgdGVtcGxhdGUuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNlY3JldHNNYW5hZ2VyOjpTZWNyZXQnLCB7XG4gICAgICBEZXNjcmlwdGlvbjogTWF0Y2guc3RyaW5nTGlrZVJlZ2V4cCgnLipBdXRoZW50aWsuKicpLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdDb250YWlucyBzZWN1cml0eSBncm91cHMnLCAoKSA9PiB7XG4gICAgdGVtcGxhdGUuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkVDMjo6U2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIEdyb3VwRGVzY3JpcHRpb246IE1hdGNoLmFueVZhbHVlKCksXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0NvbnRhaW5zIElBTSByb2xlcyBmb3IgRUNTIHRhc2tzJywgKCkgPT4ge1xuICAgIHRlbXBsYXRlLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlJvbGUnLCB7XG4gICAgICBBc3N1bWVSb2xlUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUHJpbmNpcGFsOiB7XG4gICAgICAgICAgICAgIFNlcnZpY2U6ICdlY3MtdGFza3MuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdDb250YWlucyBDbG91ZFdhdGNoIGxvZyBncm91cCcsICgpID0+IHtcbiAgICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TG9nczo6TG9nR3JvdXAnLCB7XG4gICAgICBSZXRlbnRpb25JbkRheXM6IDcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1N0YWNrIGhhcyByZXF1aXJlZCBwYXJhbWV0ZXJzJywgKCkgPT4ge1xuICAgIHRlbXBsYXRlLmhhc1BhcmFtZXRlcignRW5hYmxlRXhlY3V0ZScsIHtcbiAgICAgIFR5cGU6ICdTdHJpbmcnLFxuICAgICAgQWxsb3dlZFZhbHVlczogWyd0cnVlJywgJ2ZhbHNlJ10sXG4gICAgICBEZWZhdWx0OiAnZmFsc2UnLFxuICAgIH0pO1xuXG4gICAgdGVtcGxhdGUuaGFzUGFyYW1ldGVyKCdBdXRoZW50aWtBZG1pblVzZXJFbWFpbCcsIHtcbiAgICAgIFR5cGU6ICdTdHJpbmcnLFxuICAgIH0pO1xuXG4gICAgdGVtcGxhdGUuaGFzUGFyYW1ldGVyKCdBdXRoZW50aWtMREFQQmFzZUROJywge1xuICAgICAgVHlwZTogJ1N0cmluZycsXG4gICAgICBEZWZhdWx0OiAnREM9ZXhhbXBsZSxEQz1jb20nLFxuICAgIH0pO1xuXG4gICAgdGVtcGxhdGUuaGFzUGFyYW1ldGVyKCdJcEFkZHJlc3NUeXBlJywge1xuICAgICAgVHlwZTogJ1N0cmluZycsXG4gICAgICBBbGxvd2VkVmFsdWVzOiBbJ2lwdjQnLCAnZHVhbHN0YWNrJ10sXG4gICAgICBEZWZhdWx0OiAnZHVhbHN0YWNrJyxcbiAgICB9KTtcblxuICAgIC8vIEdpdFNoYSBwYXJhbWV0ZXIgd2FzIHJlbW92ZWQgLSBub3cgdXNlZCBkaXJlY3RseSBmcm9tIGltcG9ydHNcbiAgICAvLyBTU0xDZXJ0aWZpY2F0ZUFSTiBwYXJhbWV0ZXIgd2FzIHJlbW92ZWQgLSBub3cgaW1wb3J0ZWQgZnJvbSBiYXNlIHN0YWNrXG4gICAgXG4gICAgdGVtcGxhdGUuaGFzUGFyYW1ldGVyKCdBdXRoZW50aWtBZG1pblVzZXJFbWFpbCcsIHtcbiAgICAgIFR5cGU6ICdTdHJpbmcnLFxuICAgICAgRGVzY3JpcHRpb246ICdFLU1haWwgYWRkcmVzcyBmb3IgdGhlIEF1dGhlbnRpayBha2FkbWluIHVzZXInLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdTdGFjayBoYXMgcmVxdWlyZWQgb3V0cHV0cycsICgpID0+IHtcbiAgICAvLyBDREsgZ2VuZXJhdGVzIHVuaXF1ZSBvdXRwdXQgbmFtZXMgd2l0aCBzdWZmaXhlc1xuICAgIGNvbnN0IHRlbXBsYXRlT2JqID0gdGVtcGxhdGUudG9KU09OKCk7XG4gICAgY29uc3Qgb3V0cHV0S2V5cyA9IE9iamVjdC5rZXlzKHRlbXBsYXRlT2JqLk91dHB1dHMgfHwge30pO1xuICAgIFxuICAgIC8vIENoZWNrIGZvciBBdXRoZW50aWsgVVJMIG91dHB1dCAobmFtZSBzdGFydHMgd2l0aCAnQXV0aGVudGlrJyBidXQgbWF5IGhhdmUgc3VmZml4KVxuICAgIGNvbnN0IGF1dGhlbnRpa091dHB1dCA9IG91dHB1dEtleXMuZmluZChrZXkgPT4ga2V5LnN0YXJ0c1dpdGgoJ0F1dGhlbnRpaycpICYmICFrZXkuaW5jbHVkZXMoJ0xEQVAnKSk7XG4gICAgZXhwZWN0KGF1dGhlbnRpa091dHB1dCkudG9CZURlZmluZWQoKTtcbiAgICBpZiAoYXV0aGVudGlrT3V0cHV0KSB7XG4gICAgICBleHBlY3QodGVtcGxhdGVPYmouT3V0cHV0c1thdXRoZW50aWtPdXRwdXRdKS50b01hdGNoT2JqZWN0KHtcbiAgICAgICAgRGVzY3JpcHRpb246ICdIVFRQKFMpIEFMQiBlbmRwb2ludCBmb3IgQ05BTUUnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIExEQVAgQmFzZSBETiBvdXRwdXQgKG5hbWUgc3RhcnRzIHdpdGggJ0F1dGhlbnRpaycgYW5kIGluY2x1ZGVzICdMREFQJylcbiAgICBjb25zdCBsZGFwQmFzZURuT3V0cHV0ID0gb3V0cHV0S2V5cy5maW5kKGtleSA9PiBrZXkuc3RhcnRzV2l0aCgnQXV0aGVudGlrJykgJiYga2V5LmluY2x1ZGVzKCdMREFQJykpO1xuICAgIGV4cGVjdChsZGFwQmFzZURuT3V0cHV0KS50b0JlRGVmaW5lZCgpO1xuICAgIGlmIChsZGFwQmFzZURuT3V0cHV0KSB7XG4gICAgICBleHBlY3QodGVtcGxhdGVPYmouT3V0cHV0c1tsZGFwQmFzZURuT3V0cHV0XSkudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIERlc2NyaXB0aW9uOiAnTERBUCBCYXNlIEROJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgdGVzdCgnU3RhY2sgaGFzIGNvbmRpdGlvbnMnLCAoKSA9PiB7XG4gICAgdGVtcGxhdGUuaGFzQ29uZGl0aW9uKCdDcmVhdGVQcm9kUmVzb3VyY2VzJywge30pO1xuICB9KTtcbn0pO1xuIl19