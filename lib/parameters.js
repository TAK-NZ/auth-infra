"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DOCKER_IMAGE_LOCATION = exports.USE_AUTHENTIK_CONFIG_FILE = exports.SSL_CERTIFICATE_ARN = exports.IP_ADDRESS_TYPE = exports.AUTHENTIK_LDAP_BASE_DN = exports.AUTHENTIK_ADMIN_USER_EMAIL = exports.ENABLE_EXECUTE = exports.GIT_SHA = exports.ENV_TYPE = void 0;
exports.getGitSha = getGitSha;
exports.getParameters = getParameters;
exports.resolveStackParameters = resolveStackParameters;
const child_process_1 = require("child_process");
const environment_config_1 = require("./environment-config");
// Direct parameter exports following the reference pattern
exports.ENV_TYPE = process.env.ENV_TYPE || 'dev-test';
exports.GIT_SHA = process.env.GIT_SHA;
exports.ENABLE_EXECUTE = process.env.ENABLE_EXECUTE;
exports.AUTHENTIK_ADMIN_USER_EMAIL = process.env.AUTHENTIK_ADMIN_USER_EMAIL;
exports.AUTHENTIK_LDAP_BASE_DN = process.env.AUTHENTIK_LDAP_BASE_DN;
exports.IP_ADDRESS_TYPE = process.env.IP_ADDRESS_TYPE;
exports.SSL_CERTIFICATE_ARN = process.env.SSL_CERTIFICATE_ARN;
exports.USE_AUTHENTIK_CONFIG_FILE = process.env.USE_AUTHENTIK_CONFIG_FILE;
exports.DOCKER_IMAGE_LOCATION = process.env.DOCKER_IMAGE_LOCATION;
/**
 * Get the current git SHA for tagging resources
 * @returns Current git SHA
 */
function getGitSha() {
    try {
        // Get the current git SHA
        return (0, child_process_1.execSync)('git rev-parse --short HEAD').toString().trim();
    }
    catch (error) {
        console.warn('Unable to get git SHA, using "development"');
        return 'development';
    }
}
function getParameters() {
    return {
        envType: exports.ENV_TYPE,
        gitSha: exports.GIT_SHA || getGitSha(),
        enableExecute: exports.ENABLE_EXECUTE === 'true' || false,
    };
}
/**
 * Resolves all AuthInfra stack parameters using cascading resolution
 * Priority: 1. Environment Variables, 2. CDK Context, 3. Default Values
 */
function resolveStackParameters(stack) {
    // Environment variables (first priority)
    const STACK_NAME_ENV = process.env.STACK_NAME;
    // Context values (second priority)
    const envTypeFromContext = stack.node.tryGetContext('envType');
    const stackNameFromContext = stack.node.tryGetContext('stackName');
    const gitShaFromContext = stack.node.tryGetContext('gitSha');
    const enableExecuteFromContext = stack.node.tryGetContext('enableExecute');
    const authentikAdminUserEmailFromContext = stack.node.tryGetContext('authentikAdminUserEmail');
    const authentikLdapBaseDnFromContext = stack.node.tryGetContext('authentikLdapBaseDn');
    const ipAddressTypeFromContext = stack.node.tryGetContext('ipAddressType');
    const sslCertificateArnFromContext = stack.node.tryGetContext('sslCertificateArn');
    const useAuthentikConfigFileFromContext = stack.node.tryGetContext('useAuthentikConfigFile');
    const dockerImageLocationFromContext = stack.node.tryGetContext('dockerImageLocation');
    const authentikHostFromContext = stack.node.tryGetContext('authentikHost');
    // Resolution with environment variables taking precedence
    const envType = process.env.ENV_TYPE || envTypeFromContext || 'dev-test';
    const stackName = STACK_NAME_ENV || stackNameFromContext || `${envType}-stack`;
    const gitSha = exports.GIT_SHA || gitShaFromContext || getGitSha();
    // Get environment-specific configuration
    const envConfig = (0, environment_config_1.getEnvironmentConfig)(envType);
    // Boolean parameters: Environment variables override context, which overrides defaults
    const enableExecute = exports.ENABLE_EXECUTE !== undefined
        ? Boolean(exports.ENABLE_EXECUTE === 'true')
        : enableExecuteFromContext !== undefined
            ? Boolean(enableExecuteFromContext)
            : false;
    const useAuthentikConfigFile = exports.USE_AUTHENTIK_CONFIG_FILE !== undefined
        ? Boolean(exports.USE_AUTHENTIK_CONFIG_FILE === 'true')
        : useAuthentikConfigFileFromContext !== undefined
            ? Boolean(useAuthentikConfigFileFromContext)
            : false;
    // String parameters with validation
    const authentikAdminUserEmail = exports.AUTHENTIK_ADMIN_USER_EMAIL || authentikAdminUserEmailFromContext || '';
    const authentikLdapBaseDn = exports.AUTHENTIK_LDAP_BASE_DN || authentikLdapBaseDnFromContext || 'DC=example,DC=com';
    const ipAddressType = (exports.IP_ADDRESS_TYPE || ipAddressTypeFromContext || 'dualstack');
    const sslCertificateArn = exports.SSL_CERTIFICATE_ARN || sslCertificateArnFromContext || '';
    const dockerImageLocation = (exports.DOCKER_IMAGE_LOCATION || dockerImageLocationFromContext || 'Github');
    // For LDAP, the authentik host will be derived from the Authentik construct within the same stack
    // This is a placeholder that gets overridden during stack construction
    const authentikHost = process.env.AUTHENTIK_HOST || authentikHostFromContext || 'localhost';
    // Validate required parameters
    if (!authentikAdminUserEmail) {
        throw new Error('authentikAdminUserEmail is required. Set it via --context authentikAdminUserEmail=user@example.com or AUTHENTIK_ADMIN_USER_EMAIL environment variable.');
    }
    return {
        envType,
        stackName,
        gitSha,
        enableExecute,
        authentikAdminUserEmail,
        authentikLdapBaseDn,
        ipAddressType,
        sslCertificateArn,
        useAuthentikConfigFile,
        dockerImageLocation,
        authentikHost,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYW1ldGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBhcmFtZXRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBc0JBLDhCQVFDO0FBRUQsc0NBTUM7QUFNRCx3REErRUM7QUF2SEQsaURBQXlDO0FBQ3pDLDZEQUE0RDtBQUU1RCwyREFBMkQ7QUFDOUMsUUFBQSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUErQixJQUFJLFVBQVUsQ0FBQztBQUNyRSxRQUFBLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztBQUM5QixRQUFBLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztBQUM1QyxRQUFBLDBCQUEwQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUM7QUFDcEUsUUFBQSxzQkFBc0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDO0FBQzVELFFBQUEsZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO0FBQzlDLFFBQUEsbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztBQUN0RCxRQUFBLHlCQUF5QixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUM7QUFDbEUsUUFBQSxxQkFBcUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDO0FBRXZFOzs7R0FHRztBQUNILFNBQWdCLFNBQVM7SUFDdkIsSUFBSSxDQUFDO1FBQ0gsMEJBQTBCO1FBQzFCLE9BQU8sSUFBQSx3QkFBUSxFQUFDLDRCQUE0QixDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEUsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsSUFBSSxDQUFDLDRDQUE0QyxDQUFDLENBQUM7UUFDM0QsT0FBTyxhQUFhLENBQUM7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QkFBOEIsSUFBSSxtQkFBbUIsQ0FBQztJQUM1RyxNQUFNLGFBQWEsR0FBRyxDQUFDLHVCQUFlLElBQUksd0JBQXdCLElBQUksV0FBVyxDQUF5QixDQUFDO0lBQzNHLE1BQU0saUJBQWlCLEdBQUcsMkJBQW1CLElBQUksNEJBQTRCLElBQUksRUFBRSxDQUFDO0lBQ3BGLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyw2QkFBcUIsSUFBSSw4QkFBOEIsSUFBSSxRQUFRLENBQTJCLENBQUM7SUFFNUgsa0dBQWtHO0lBQ2xHLHVFQUF1RTtJQUN2RSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSx3QkFBd0IsSUFBSSxXQUFXLENBQUM7SUFFNUYsK0JBQStCO0lBQy9CLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0pBQXdKLENBQUMsQ0FBQztJQUM1SyxDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU87UUFDUCxTQUFTO1FBQ1QsTUFBTTtRQUNOLGFBQWE7UUFDYix1QkFBdUI7UUFDdkIsbUJBQW1CO1FBQ25CLGFBQWE7UUFDYixpQkFBaUI7UUFDakIsc0JBQXNCO1FBQ3RCLG1CQUFtQjtRQUNuQixhQUFhO0tBQ2QsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFBhcmFtZXRlciBoYW5kbGluZyBhbmQgZW52aXJvbm1lbnQgdmFyaWFibGUgcmVzb2x1dGlvbiBmb3IgdGhlIEF1dGhJbmZyYSBzdGFja1xuICovXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IGdldEVudmlyb25tZW50Q29uZmlnIH0gZnJvbSAnLi9lbnZpcm9ubWVudC1jb25maWcnO1xuXG4vLyBEaXJlY3QgcGFyYW1ldGVyIGV4cG9ydHMgZm9sbG93aW5nIHRoZSByZWZlcmVuY2UgcGF0dGVyblxuZXhwb3J0IGNvbnN0IEVOVl9UWVBFID0gcHJvY2Vzcy5lbnYuRU5WX1RZUEUgYXMgJ3Byb2QnIHwgJ2Rldi10ZXN0JyB8fCAnZGV2LXRlc3QnO1xuZXhwb3J0IGNvbnN0IEdJVF9TSEEgPSBwcm9jZXNzLmVudi5HSVRfU0hBO1xuZXhwb3J0IGNvbnN0IEVOQUJMRV9FWEVDVVRFID0gcHJvY2Vzcy5lbnYuRU5BQkxFX0VYRUNVVEU7XG5leHBvcnQgY29uc3QgQVVUSEVOVElLX0FETUlOX1VTRVJfRU1BSUwgPSBwcm9jZXNzLmVudi5BVVRIRU5USUtfQURNSU5fVVNFUl9FTUFJTDtcbmV4cG9ydCBjb25zdCBBVVRIRU5USUtfTERBUF9CQVNFX0ROID0gcHJvY2Vzcy5lbnYuQVVUSEVOVElLX0xEQVBfQkFTRV9ETjtcbmV4cG9ydCBjb25zdCBJUF9BRERSRVNTX1RZUEUgPSBwcm9jZXNzLmVudi5JUF9BRERSRVNTX1RZUEU7XG5leHBvcnQgY29uc3QgU1NMX0NFUlRJRklDQVRFX0FSTiA9IHByb2Nlc3MuZW52LlNTTF9DRVJUSUZJQ0FURV9BUk47XG5leHBvcnQgY29uc3QgVVNFX0FVVEhFTlRJS19DT05GSUdfRklMRSA9IHByb2Nlc3MuZW52LlVTRV9BVVRIRU5USUtfQ09ORklHX0ZJTEU7XG5leHBvcnQgY29uc3QgRE9DS0VSX0lNQUdFX0xPQ0FUSU9OID0gcHJvY2Vzcy5lbnYuRE9DS0VSX0lNQUdFX0xPQ0FUSU9OO1xuXG4vKipcbiAqIEdldCB0aGUgY3VycmVudCBnaXQgU0hBIGZvciB0YWdnaW5nIHJlc291cmNlc1xuICogQHJldHVybnMgQ3VycmVudCBnaXQgU0hBXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRHaXRTaGEoKTogc3RyaW5nIHtcbiAgdHJ5IHtcbiAgICAvLyBHZXQgdGhlIGN1cnJlbnQgZ2l0IFNIQVxuICAgIHJldHVybiBleGVjU3luYygnZ2l0IHJldi1wYXJzZSAtLXNob3J0IEhFQUQnKS50b1N0cmluZygpLnRyaW0oKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oJ1VuYWJsZSB0byBnZXQgZ2l0IFNIQSwgdXNpbmcgXCJkZXZlbG9wbWVudFwiJyk7XG4gICAgcmV0dXJuICdkZXZlbG9wbWVudCc7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhcmFtZXRlcnMoKSB7XG4gIHJldHVybiB7XG4gICAgZW52VHlwZTogRU5WX1RZUEUsXG4gICAgZ2l0U2hhOiBHSVRfU0hBIHx8IGdldEdpdFNoYSgpLFxuICAgIGVuYWJsZUV4ZWN1dGU6IEVOQUJMRV9FWEVDVVRFID09PSAndHJ1ZScgfHwgZmFsc2UsXG4gIH07XG59XG5cbi8qKlxuICogUmVzb2x2ZXMgYWxsIEF1dGhJbmZyYSBzdGFjayBwYXJhbWV0ZXJzIHVzaW5nIGNhc2NhZGluZyByZXNvbHV0aW9uXG4gKiBQcmlvcml0eTogMS4gRW52aXJvbm1lbnQgVmFyaWFibGVzLCAyLiBDREsgQ29udGV4dCwgMy4gRGVmYXVsdCBWYWx1ZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVTdGFja1BhcmFtZXRlcnMoc3RhY2s6IGNkay5TdGFjayk6IHtcbiAgZW52VHlwZTogc3RyaW5nO1xuICBzdGFja05hbWU6IHN0cmluZztcbiAgZ2l0U2hhOiBzdHJpbmc7XG4gIGVuYWJsZUV4ZWN1dGU6IGJvb2xlYW47XG4gIGF1dGhlbnRpa0FkbWluVXNlckVtYWlsOiBzdHJpbmc7XG4gIGF1dGhlbnRpa0xkYXBCYXNlRG46IHN0cmluZztcbiAgaXBBZGRyZXNzVHlwZTogJ2lwdjQnIHwgJ2R1YWxzdGFjayc7XG4gIHNzbENlcnRpZmljYXRlQXJuOiBzdHJpbmc7XG4gIHVzZUF1dGhlbnRpa0NvbmZpZ0ZpbGU6IGJvb2xlYW47XG4gIGRvY2tlckltYWdlTG9jYXRpb246ICdHaXRodWInIHwgJ0xvY2FsIEVDUic7XG4gIGF1dGhlbnRpa0hvc3Q6IHN0cmluZztcbn0ge1xuICAvLyBFbnZpcm9ubWVudCB2YXJpYWJsZXMgKGZpcnN0IHByaW9yaXR5KVxuICBjb25zdCBTVEFDS19OQU1FX0VOViA9IHByb2Nlc3MuZW52LlNUQUNLX05BTUU7XG4gIFxuICAvLyBDb250ZXh0IHZhbHVlcyAoc2Vjb25kIHByaW9yaXR5KVxuICBjb25zdCBlbnZUeXBlRnJvbUNvbnRleHQgPSBzdGFjay5ub2RlLnRyeUdldENvbnRleHQoJ2VudlR5cGUnKTtcbiAgY29uc3Qgc3RhY2tOYW1lRnJvbUNvbnRleHQgPSBzdGFjay5ub2RlLnRyeUdldENvbnRleHQoJ3N0YWNrTmFtZScpO1xuICBjb25zdCBnaXRTaGFGcm9tQ29udGV4dCA9IHN0YWNrLm5vZGUudHJ5R2V0Q29udGV4dCgnZ2l0U2hhJyk7XG4gIGNvbnN0IGVuYWJsZUV4ZWN1dGVGcm9tQ29udGV4dCA9IHN0YWNrLm5vZGUudHJ5R2V0Q29udGV4dCgnZW5hYmxlRXhlY3V0ZScpO1xuICBjb25zdCBhdXRoZW50aWtBZG1pblVzZXJFbWFpbEZyb21Db250ZXh0ID0gc3RhY2subm9kZS50cnlHZXRDb250ZXh0KCdhdXRoZW50aWtBZG1pblVzZXJFbWFpbCcpO1xuICBjb25zdCBhdXRoZW50aWtMZGFwQmFzZURuRnJvbUNvbnRleHQgPSBzdGFjay5ub2RlLnRyeUdldENvbnRleHQoJ2F1dGhlbnRpa0xkYXBCYXNlRG4nKTtcbiAgY29uc3QgaXBBZGRyZXNzVHlwZUZyb21Db250ZXh0ID0gc3RhY2subm9kZS50cnlHZXRDb250ZXh0KCdpcEFkZHJlc3NUeXBlJyk7XG4gIGNvbnN0IHNzbENlcnRpZmljYXRlQXJuRnJvbUNvbnRleHQgPSBzdGFjay5ub2RlLnRyeUdldENvbnRleHQoJ3NzbENlcnRpZmljYXRlQXJuJyk7XG4gIGNvbnN0IHVzZUF1dGhlbnRpa0NvbmZpZ0ZpbGVGcm9tQ29udGV4dCA9IHN0YWNrLm5vZGUudHJ5R2V0Q29udGV4dCgndXNlQXV0aGVudGlrQ29uZmlnRmlsZScpO1xuICBjb25zdCBkb2NrZXJJbWFnZUxvY2F0aW9uRnJvbUNvbnRleHQgPSBzdGFjay5ub2RlLnRyeUdldENvbnRleHQoJ2RvY2tlckltYWdlTG9jYXRpb24nKTtcbiAgY29uc3QgYXV0aGVudGlrSG9zdEZyb21Db250ZXh0ID0gc3RhY2subm9kZS50cnlHZXRDb250ZXh0KCdhdXRoZW50aWtIb3N0Jyk7XG5cbiAgLy8gUmVzb2x1dGlvbiB3aXRoIGVudmlyb25tZW50IHZhcmlhYmxlcyB0YWtpbmcgcHJlY2VkZW5jZVxuICBjb25zdCBlbnZUeXBlID0gcHJvY2Vzcy5lbnYuRU5WX1RZUEUgfHwgZW52VHlwZUZyb21Db250ZXh0IHx8ICdkZXYtdGVzdCc7XG4gIGNvbnN0IHN0YWNrTmFtZSA9IFNUQUNLX05BTUVfRU5WIHx8IHN0YWNrTmFtZUZyb21Db250ZXh0IHx8IGAke2VudlR5cGV9LXN0YWNrYDtcbiAgY29uc3QgZ2l0U2hhID0gR0lUX1NIQSB8fCBnaXRTaGFGcm9tQ29udGV4dCB8fCBnZXRHaXRTaGEoKTtcblxuICAvLyBHZXQgZW52aXJvbm1lbnQtc3BlY2lmaWMgY29uZmlndXJhdGlvblxuICBjb25zdCBlbnZDb25maWcgPSBnZXRFbnZpcm9ubWVudENvbmZpZyhlbnZUeXBlKTtcblxuICAvLyBCb29sZWFuIHBhcmFtZXRlcnM6IEVudmlyb25tZW50IHZhcmlhYmxlcyBvdmVycmlkZSBjb250ZXh0LCB3aGljaCBvdmVycmlkZXMgZGVmYXVsdHNcbiAgY29uc3QgZW5hYmxlRXhlY3V0ZSA9IEVOQUJMRV9FWEVDVVRFICE9PSB1bmRlZmluZWQgXG4gICAgPyBCb29sZWFuKEVOQUJMRV9FWEVDVVRFID09PSAndHJ1ZScpXG4gICAgOiBlbmFibGVFeGVjdXRlRnJvbUNvbnRleHQgIT09IHVuZGVmaW5lZFxuICAgID8gQm9vbGVhbihlbmFibGVFeGVjdXRlRnJvbUNvbnRleHQpXG4gICAgOiBmYWxzZTtcblxuICBjb25zdCB1c2VBdXRoZW50aWtDb25maWdGaWxlID0gVVNFX0FVVEhFTlRJS19DT05GSUdfRklMRSAhPT0gdW5kZWZpbmVkXG4gICAgPyBCb29sZWFuKFVTRV9BVVRIRU5USUtfQ09ORklHX0ZJTEUgPT09ICd0cnVlJylcbiAgICA6IHVzZUF1dGhlbnRpa0NvbmZpZ0ZpbGVGcm9tQ29udGV4dCAhPT0gdW5kZWZpbmVkXG4gICAgPyBCb29sZWFuKHVzZUF1dGhlbnRpa0NvbmZpZ0ZpbGVGcm9tQ29udGV4dClcbiAgICA6IGZhbHNlO1xuXG4gIC8vIFN0cmluZyBwYXJhbWV0ZXJzIHdpdGggdmFsaWRhdGlvblxuICBjb25zdCBhdXRoZW50aWtBZG1pblVzZXJFbWFpbCA9IEFVVEhFTlRJS19BRE1JTl9VU0VSX0VNQUlMIHx8IGF1dGhlbnRpa0FkbWluVXNlckVtYWlsRnJvbUNvbnRleHQgfHwgJyc7XG4gIGNvbnN0IGF1dGhlbnRpa0xkYXBCYXNlRG4gPSBBVVRIRU5USUtfTERBUF9CQVNFX0ROIHx8IGF1dGhlbnRpa0xkYXBCYXNlRG5Gcm9tQ29udGV4dCB8fCAnREM9ZXhhbXBsZSxEQz1jb20nO1xuICBjb25zdCBpcEFkZHJlc3NUeXBlID0gKElQX0FERFJFU1NfVFlQRSB8fCBpcEFkZHJlc3NUeXBlRnJvbUNvbnRleHQgfHwgJ2R1YWxzdGFjaycpIGFzICdpcHY0JyB8ICdkdWFsc3RhY2snO1xuICBjb25zdCBzc2xDZXJ0aWZpY2F0ZUFybiA9IFNTTF9DRVJUSUZJQ0FURV9BUk4gfHwgc3NsQ2VydGlmaWNhdGVBcm5Gcm9tQ29udGV4dCB8fCAnJztcbiAgY29uc3QgZG9ja2VySW1hZ2VMb2NhdGlvbiA9IChET0NLRVJfSU1BR0VfTE9DQVRJT04gfHwgZG9ja2VySW1hZ2VMb2NhdGlvbkZyb21Db250ZXh0IHx8ICdHaXRodWInKSBhcyAnR2l0aHViJyB8ICdMb2NhbCBFQ1InO1xuICBcbiAgLy8gRm9yIExEQVAsIHRoZSBhdXRoZW50aWsgaG9zdCB3aWxsIGJlIGRlcml2ZWQgZnJvbSB0aGUgQXV0aGVudGlrIGNvbnN0cnVjdCB3aXRoaW4gdGhlIHNhbWUgc3RhY2tcbiAgLy8gVGhpcyBpcyBhIHBsYWNlaG9sZGVyIHRoYXQgZ2V0cyBvdmVycmlkZGVuIGR1cmluZyBzdGFjayBjb25zdHJ1Y3Rpb25cbiAgY29uc3QgYXV0aGVudGlrSG9zdCA9IHByb2Nlc3MuZW52LkFVVEhFTlRJS19IT1NUIHx8IGF1dGhlbnRpa0hvc3RGcm9tQ29udGV4dCB8fCAnbG9jYWxob3N0JztcblxuICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBwYXJhbWV0ZXJzXG4gIGlmICghYXV0aGVudGlrQWRtaW5Vc2VyRW1haWwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2F1dGhlbnRpa0FkbWluVXNlckVtYWlsIGlzIHJlcXVpcmVkLiBTZXQgaXQgdmlhIC0tY29udGV4dCBhdXRoZW50aWtBZG1pblVzZXJFbWFpbD11c2VyQGV4YW1wbGUuY29tIG9yIEFVVEhFTlRJS19BRE1JTl9VU0VSX0VNQUlMIGVudmlyb25tZW50IHZhcmlhYmxlLicpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBlbnZUeXBlLFxuICAgIHN0YWNrTmFtZSxcbiAgICBnaXRTaGEsXG4gICAgZW5hYmxlRXhlY3V0ZSxcbiAgICBhdXRoZW50aWtBZG1pblVzZXJFbWFpbCxcbiAgICBhdXRoZW50aWtMZGFwQmFzZURuLFxuICAgIGlwQWRkcmVzc1R5cGUsXG4gICAgc3NsQ2VydGlmaWNhdGVBcm4sXG4gICAgdXNlQXV0aGVudGlrQ29uZmlnRmlsZSxcbiAgICBkb2NrZXJJbWFnZUxvY2F0aW9uLFxuICAgIGF1dGhlbnRpa0hvc3QsXG4gIH07XG59XG4iXX0=