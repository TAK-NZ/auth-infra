import { Stack, aws_ec2 as ec2, aws_ecs as ecs, aws_kms as kms, CfnOutput } from 'aws-cdk-lib';
import { importBaseInfraValue } from './stack-naming';
import { getEnvironmentConfig } from './environment-config';
import { Database } from './constructs/database';
import { Redis } from './constructs/redis';
import { Efs } from './constructs/efs';
import { SecretsManager } from './constructs/secrets-manager';
import { Authentik } from './constructs/authentik';
/**
 * Main CDK stack for the Auth Infrastructure
 */
export class AuthInfraStack extends Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // Get environment configuration
        const config = getEnvironmentConfig(props.envType);
        // Import VPC and networking from base infrastructure
        const vpc = ec2.Vpc.fromLookup(this, 'VPC', {
            vpcId: importBaseInfraValue(props.stackName, 'vpc-id')
        });
        // Import KMS key from base infrastructure
        const kmsKey = kms.Key.fromKeyArn(this, 'KMSKey', importBaseInfraValue(props.stackName, 'kms'));
        // Create ECS cluster
        const ecsCluster = new ecs.Cluster(this, 'ECSCluster', {
            vpc,
            clusterName: `${id}-cluster`,
            enableFargateCapacityProviders: true
        });
        // Create security group for ECS tasks
        const ecsSecurityGroup = new ec2.SecurityGroup(this, 'ECSSecurityGroup', {
            vpc,
            description: 'Security group for ECS tasks',
            allowAllOutbound: true
        });
        // Allow HTTP/HTTPS traffic to ECS tasks
        ecsSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80), 'Allow HTTP traffic');
        ecsSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), 'Allow HTTPS traffic');
        ecsSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(9000), 'Allow Authentik traffic');
        // Create security group for database
        const dbSecurityGroup = new ec2.SecurityGroup(this, 'DBSecurityGroup', {
            vpc,
            description: 'Security group for database',
            allowAllOutbound: false
        });
        // Allow PostgreSQL access from ECS tasks
        dbSecurityGroup.addIngressRule(ec2.Peer.securityGroupId(ecsSecurityGroup.securityGroupId), ec2.Port.tcp(5432), 'Allow PostgreSQL access from ECS tasks');
        // Create security group for Redis
        const redisSecurityGroup = new ec2.SecurityGroup(this, 'RedisSecurityGroup', {
            vpc,
            description: 'Security group for Redis',
            allowAllOutbound: false
        });
        // Allow Redis access from ECS tasks
        redisSecurityGroup.addIngressRule(ec2.Peer.securityGroupId(ecsSecurityGroup.securityGroupId), ec2.Port.tcp(6379), 'Allow Redis access from ECS tasks');
        // Create SecretsManager construct
        this.secretsManager = new SecretsManager(this, 'SecretsManager', {
            environment: props.stackName,
            kmsKey
        });
        // Create Database construct
        this.database = new Database(this, 'Database', {
            environment: props.stackName,
            config,
            vpc,
            kmsKey,
            securityGroups: [dbSecurityGroup]
        });
        // Create Redis construct
        this.redis = new Redis(this, 'Redis', {
            environment: props.stackName,
            config,
            vpc,
            kmsKey,
            securityGroups: [redisSecurityGroup]
        });
        // Create EFS construct
        this.efs = new Efs(this, 'EFS', {
            environment: props.stackName,
            vpc,
            kmsKey,
            allowAccessFrom: [ecsSecurityGroup]
        });
        // Create default parameters (these would normally come from the app)
        const defaultParams = {
            gitSha: 'development',
            environment: props.stackName,
            envType: props.envType,
            enableExecute: false,
            sslCertificateArn: '',
            authentikAdminUserEmail: '',
            authentikLdapBaseDn: 'DC=example,DC=com',
            useAuthentikConfigFile: false,
            ipAddressType: 'dualstack',
            dockerImageLocation: 'Github'
        };
        // Merge with provided parameters
        const parameters = { ...defaultParams, ...(props.parameters || {}) };
        // Create Authentik construct
        this.authentik = new Authentik(this, 'Authentik', {
            environment: props.stackName,
            config,
            vpc,
            ecsSecurityGroup,
            ecsCluster,
            sslCertificateArn: parameters.sslCertificateArn,
            adminUserEmail: parameters.authentikAdminUserEmail,
            ldapBaseDn: parameters.authentikLdapBaseDn,
            useConfigFile: parameters.useAuthentikConfigFile,
            ipAddressType: parameters.ipAddressType,
            dockerImageLocation: parameters.dockerImageLocation,
            enableExecute: parameters.enableExecute,
            dbSecret: this.database.masterSecret,
            dbHostname: this.database.hostname,
            redisAuthToken: this.redis.authToken,
            redisHostname: this.redis.hostname,
            secretKey: this.secretsManager.secretKey,
            adminUserPassword: this.secretsManager.adminUserPassword,
            adminUserToken: this.secretsManager.adminUserToken,
            ldapToken: this.secretsManager.ldapToken,
            efsId: this.efs.fileSystem.fileSystemId,
            efsMediaAccessPointId: this.efs.mediaAccessPoint.accessPointId,
            efsCustomTemplatesAccessPointId: this.efs.customTemplatesAccessPoint.accessPointId
        });
        // Create stack outputs
        new CfnOutput(this, 'StackName', {
            value: this.stackName,
            description: 'Name of the deployed stack'
        });
        new CfnOutput(this, 'Environment', {
            value: props.stackName,
            description: 'Environment name'
        });
        new CfnOutput(this, 'EnvType', {
            value: props.envType,
            description: 'Environment type'
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1pbmZyYS1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImF1dGgtaW5mcmEtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUNMLEtBQUssRUFFTCxPQUFPLElBQUksR0FBRyxFQUNkLE9BQU8sSUFBSSxHQUFHLEVBQ2QsT0FBTyxJQUFJLEdBQUcsRUFDZCxTQUFTLEVBQ1YsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFNUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdkMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQXNCbkQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sY0FBZSxTQUFRLEtBQUs7SUEwQnZDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBMEI7UUFDbEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsZ0NBQWdDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVuRCxxREFBcUQ7UUFDckQsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRTtZQUMxQyxLQUFLLEVBQUUsb0JBQW9CLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUM7U0FDdkQsQ0FBQyxDQUFDO1FBRUgsMENB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QUFDLFNBQVM7WUFDdEIsV0FBVyxFQUFFLGtCQUFrQjtTQUNoQyxDQUFDLENBQUM7UUFFSCxJQUFJLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1lBQzdCLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTztZQUNwQixXQUFXLEVBQUUsa0JBQWtCO1NBQ2hDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTWFpbiBBdXRoIEluZnJhc3RydWN0dXJlIFN0YWNrIC0gQ0RLIGltcGxlbWVudGF0aW9uXG4gKi9cbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgU3RhY2ssXG4gIFN0YWNrUHJvcHMsXG4gIGF3c19lYzIgYXMgZWMyLFxuICBhd3NfZWNzIGFzIGVjcyxcbiAgYXdzX2ttcyBhcyBrbXMsXG4gIENmbk91dHB1dFxufSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBpbXBvcnRCYXNlSW5mcmFWYWx1ZSB9IGZyb20gJy4vc3RhY2stbmFtaW5nJztcbmltcG9ydCB7IGdldEVudmlyb25tZW50Q29uZmlnIH0gZnJvbSAnLi9lbnZpcm9ubWVudC1jb25maWcnO1xuaW1wb3J0IHsgQXV0aEluZnJhUGFyYW1ldGVycyB9IGZyb20gJy4vcGFyYW1ldGVycyc7XG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gJy4vY29uc3RydWN0cy9kYXRhYmFzZSc7XG5pbXBvcnQgeyBSZWRpcyB9IGZyb20gJy4vY29uc3RydWN0cy9yZWRpcyc7XG5pbXBvcnQgeyBFZnMgfSBmcm9tICcuL2NvbnN0cnVjdHMvZWZzJztcbmltcG9ydCB7IFNlY3JldHNNYW5hZ2VyIH0gZnJvbSAnLi9jb25zdHJ1Y3RzL3NlY3JldHMtbWFuYWdlcic7XG5pbXBvcnQgeyBBdXRoZW50aWsgfSBmcm9tICcuL2NvbnN0cnVjdHMvYXV0aGVudGlrJztcblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciB0aGUgQXV0aCBJbmZyYXN0cnVjdHVyZSBTdGFja1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhJbmZyYVN0YWNrUHJvcHMgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgLyoqXG4gICAqIFN0YWNrIG5hbWUvZW52aXJvbm1lbnRcbiAgICovXG4gIHN0YWNrTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBFbnZpcm9ubWVudCB0eXBlXG4gICAqL1xuICBlbnZUeXBlOiAncHJvZCcgfCAnZGV2LXRlc3QnO1xuXG4gIC8qKlxuICAgKiBPcHRpb25hbCBwYXJhbWV0ZXJzIG92ZXJyaWRlXG4gICAqL1xuICBwYXJhbWV0ZXJzPzogUGFydGlhbDxBdXRoSW5mcmFQYXJhbWV0ZXJzPjtcbn1cblxuLyoqXG4gKiBNYWluIENESyBzdGFjayBmb3IgdGhlIEF1dGggSW5mcmFzdHJ1Y3R1cmVcbiAqL1xuZXhwb3J0IGNsYXNzIEF1dGhJbmZyYVN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICAvKipcbiAgICogVGhlIGRhdGFiYXNlIGNvbnN0cnVjdFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGRhdGFiYXNlOiBEYXRhYmFzZTtcblxuICAvKipcbiAgICogVGhlIFJlZGlzIGNvbnN0cnVjdFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHJlZGlzOiBSZWRpcztcblxuICAvKipcbiAgICogVGhlIEVGUyBjb25zdHJ1Y3RcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBlZnM6IEVmcztcblxuICAvKipcbiAgICogVGhlIHNlY3JldHMgbWFuYWdlciBjb25zdHJ1Y3RcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBzZWNyZXRzTWFuYWdlcjogU2VjcmV0c01hbmFnZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBBdXRoZW50aWsgY29uc3RydWN0XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYXV0aGVudGlrOiBBdXRoZW50aWs7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEF1dGhJbmZyYVN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIC8vIEdldCBlbnZpcm9ubWVudCBjb25maWd1cmF0aW9uXG4gICAgY29uc3QgY29uZmlnID0gZ2V0RW52aXJvbm1lbnRDb25maWcocHJvcHMuZW52VHlwZSk7XG5cbiAgICAvLyBJbXBvcnQgVlBDIGFuZCBuZXR3b3JraW5nIGZyb20gYmFzZSBpbmZyYXN0cnVjdHVyZVxuICAgIGNvbnN0IHZwYyA9IGVjMi5WcGMuZnJvbUxvb2t1cCh0aGlzLCAnVlBDJywge1xuICAgICAgdnBjSWQ6IGltcG9ydEJhc2VJbmZyYVZhbHVlKHByb3BzLnN0YWNrTmFtZSwgJ3ZwYy1pZCcpXG4gICAgfSk7XG5cbiAgICAvLyBJbXBvcnQgS01TIGtleSBmcm9tIGJhc2UgaW5mcmFzdHJ1Y3R1cmVcbiAgICBjb25zdCBrbXNLZXkgPSBrbXMuS2V5LmZyb21LZXlBcm4odGhpcywgJ0tNU0tleScsIFxuICAgICAgaW1wb3J0QmFzZUluZnJhVmFsdWUocHJvcHMuc3RhY2tOYW1lLCAna21zJylcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIEVDUyBjbHVzdGVyXG4gICAgY29uc3QgZWNzQ2x1c3RlciA9IG5ldyBlY3MuQ2x1c3Rlcih0aGlzLCAnRUNTQ2x1c3RlcicsIHtcbiAgICAgIHZwYyxcbiAgICAgIGNsdXN0ZXJOYW1lOiBgJHtpZH0tY2x1c3RlcmAsXG4gICAgICBlbmFibGVGYXJnYXRlQ2FwYWNpdHlQcm92aWRlcnM6IHRydWVcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBzZWN1cml0eSBncm91cCBmb3IgRUNTIHRhc2tzXG4gICAgY29uc3QgZWNzU2VjdXJpdHlHcm91cCA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnRUNTU2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIHZwYyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnU2VjdXJpdHkgZ3JvdXAgZm9yIEVDUyB0YXNrcycsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlXG4gICAgfSk7XG5cbiAgICAvLyBBbGxvdyBIVFRQL0hUVFBTIHRyYWZmaWMgdG8gRUNTIHRhc2tzXG4gICAgZWNzU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGVjMi5QZWVyLmFueUlwdjQoKSxcbiAgICAgIGVjMi5Qb3J0LnRjcCg4MCksXG4gICAgICAnQWxsb3cgSFRUUCB0cmFmZmljJ1xuICAgICk7XG5cbiAgICBlY3NTZWN1cml0eUdyb3VwLmFkZEluZ3Jlc3NSdWxlKFxuICAgICAgZWMyLlBlZXIuYW55SXB2NCgpLFxuICAgICAgZWMyLlBvcnQudGNwKDQ0MyksXG4gICAgICAnQWxsb3cgSFRUUFMgdHJhZmZpYydcbiAgICApO1xuXG4gICAgZWNzU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGVjMi5QZWVyLmFueUlwdjQoKSxcbiAgICAgIGVjMi5Qb3J0LnRjcCg5MDAwKSxcbiAgICAgICdBbGxvdyBBdXRoZW50aWsgdHJhZmZpYydcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIHNlY3VyaXR5IGdyb3VwIGZvciBkYXRhYmFzZVxuICAgIGNvbnN0IGRiU2VjdXJpdHlHcm91cCA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnREJTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjLFxuICAgICAgZGVzY3JpcHRpb246ICdTZWN1cml0eSBncm91cCBmb3IgZGF0YWJhc2UnLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogZmFsc2VcbiAgICB9KTtcblxuICAgIC8vIEFsbG93IFBvc3RncmVTUUwgYWNjZXNzIGZyb20gRUNTIHRhc2tzXG4gICAgZGJTZWN1cml0eUdyb3VwLmFkZEluZ3Jlc3NSdWxlKFxuICAgICAgZWMyLlBlZXIuc2VjdXJpdHlHcm91cElkKGVjc1NlY3VyaXR5R3JvdXAuc2VjdXJpdHlHcm91cElkKSxcbiAgICAgIGVjMi5Qb3J0LnRjcCg1NDMyKSxcbiAgICAgICdBbGxvdyBQb3N0Z3JlU1FMIGFjY2VzcyBmcm9tIEVDUyB0YXNrcydcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIHNlY3VyaXR5IGdyb3VwIGZvciBSZWRpc1xuICAgIGNvbnN0IHJlZGlzU2VjdXJpdHlHcm91cCA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnUmVkaXNTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjLFxuICAgICAgZGVzY3JpcHRpb246ICdTZWN1cml0eSBncm91cCBmb3IgUmVkaXMnLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogZmFsc2VcbiAgICB9KTtcblxuICAgIC8vIEFsbG93IFJlZGlzIGFjY2VzcyBmcm9tIEVDUyB0YXNrc1xuICAgIHJlZGlzU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGVjMi5QZWVyLnNlY3VyaXR5R3JvdXBJZChlY3NTZWN1cml0eUdyb3VwLnNlY3VyaXR5R3JvdXBJZCksXG4gICAgICBlYzIuUG9ydC50Y3AoNjM3OSksXG4gICAgICAnQWxsb3cgUmVkaXMgYWNjZXNzIGZyb20gRUNTIHRhc2tzJ1xuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgU2VjcmV0c01hbmFnZXIgY29uc3RydWN0XG4gICAgdGhpcy5zZWNyZXRzTWFuYWdlciA9IG5ldyBTZWNyZXRzTWFuYWdlcih0aGlzLCAnU2VjcmV0c01hbmFnZXInLCB7XG4gICAgICBlbnZpcm9ubWVudDogcHJvcHMuc3RhY2tOYW1lLFxuICAgICAga21zS2V5XG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgRGF0YWJhc2UgY29uc3RydWN0XG4gICAgdGhpcy5kYXRhYmFzZSA9IG5ldyBEYXRhYmFzZSh0aGlzLCAnRGF0YWJhc2UnLCB7XG4gICAgICBlbnZpcm9ubWVudDogcHJvcHMuc3RhY2tOYW1lLFxuICAgICAgY29uZmlnLFxuICAgICAgdnBjLFxuICAgICAga21zS2V5LFxuICAgICAgc2VjdXJpdHlHcm91cHM6IFtkYlNlY3VyaXR5R3JvdXBdXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgUmVkaXMgY29uc3RydWN0XG4gICAgdGhpcy5yZWRpcyA9IG5ldyBSZWRpcyh0aGlzLCAnUmVkaXMnLCB7XG4gICAgICBlbnZpcm9ubWVudDogcHJvcHMuc3RhY2tOYW1lLFxuICAgICAgY29uZmlnLFxuICAgICAgdnBjLFxuICAgICAga21zS2V5LFxuICAgICAgc2VjdXJpdHlHcm91cHM6IFtyZWRpc1NlY3VyaXR5R3JvdXBdXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgRUZTIGNvbnN0cnVjdFxuICAgIHRoaXMuZWZzID0gbmV3IEVmcyh0aGlzLCAnRUZTJywge1xuICAgICAgZW52aXJvbm1lbnQ6IHByb3BzLnN0YWNrTmFtZSxcbiAgICAgIHZwYyxcbiAgICAgIGttc0tleSxcbiAgICAgIGFsbG93QWNjZXNzRnJvbTogW2Vjc1NlY3VyaXR5R3JvdXBdXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgZGVmYXVsdCBwYXJhbWV0ZXJzICh0aGVzZSB3b3VsZCBub3JtYWxseSBjb21lIGZyb20gdGhlIGFwcClcbiAgICBjb25zdCBkZWZhdWx0UGFyYW1zOiBBdXRoSW5mcmFQYXJhbWV0ZXJzID0ge1xuICAgICAgZ2l0U2hhOiAnZGV2ZWxvcG1lbnQnLFxuICAgICAgZW52aXJvbm1lbnQ6IHByb3BzLnN0YWNrTmFtZSxcbiAgICAgIGVudlR5cGU6IHByb3BzLmVudlR5cGUsXG4gICAgICBlbmFibGVFeGVjdXRlOiBmYWxzZSxcbiAgICAgIHNzbENlcnRpZmljYXRlQXJuOiAnJyxcbiAgICAgIGF1dGhlbnRpa0FkbWluVXNlckVtYWlsOiAnJyxcbiAgICAgIGF1dGhlbnRpa0xkYXBCYXNlRG46ICdEQz1leGFtcGxlLERDPWNvbScsXG4gICAgICB1c2VBdXRoZW50aWtDb25maWdGaWxlOiBmYWxzZSxcbiAgICAgIGlwQWRkcmVzc1R5cGU6ICdkdWFsc3RhY2snLFxuICAgICAgZG9ja2VySW1hZ2VMb2NhdGlvbjogJ0dpdGh1YidcbiAgICB9O1xuXG4gICAgLy8gTWVyZ2Ugd2l0aCBwcm92aWRlZCBwYXJhbWV0ZXJzXG4gICAgY29uc3QgcGFyYW1ldGVycyA9IHsgLi4uZGVmYXVsdFBhcmFtcywgLi4uKHByb3BzLnBhcmFtZXRlcnMgfHwge30pIH07XG5cbiAgICAvLyBDcmVhdGUgQXV0aGVudGlrIGNvbnN0cnVjdFxuICAgIHRoaXMuYXV0aGVudGlrID0gbmV3IEF1dGhlbnRpayh0aGlzLCAnQXV0aGVudGlrJywge1xuICAgICAgZW52aXJvbm1lbnQ6IHByb3BzLnN0YWNrTmFtZSxcbiAgICAgIGNvbmZpZyxcbiAgICAgIHZwYyxcbiAgICAgIGVjc1NlY3VyaXR5R3JvdXAsXG4gICAgICBlY3NDbHVzdGVyLFxuICAgICAgc3NsQ2VydGlmaWNhdGVBcm46IHBhcmFtZXRlcnMuc3NsQ2VydGlmaWNhdGVBcm4sXG4gICAgICBhZG1pblVzZXJFbWFpbDogcGFyYW1ldGVycy5hdXRoZW50aWtBZG1pblVzZXJFbWFpbCxcbiAgICAgIGxkYXBCYXNlRG46IHBhcmFtZXRlcnMuYXV0aGVudGlrTGRhcEJhc2VEbixcbiAgICAgIHVzZUNvbmZpZ0ZpbGU6IHBhcmFtZXRlcnMudXNlQXV0aGVudGlrQ29uZmlnRmlsZSxcbiAgICAgIGlwQWRkcmVzc1R5cGU6IHBhcmFtZXRlcnMuaXBBZGRyZXNzVHlwZSxcbiAgICAgIGRvY2tlckltYWdlTG9jYXRpb246IHBhcmFtZXRlcnMuZG9ja2VySW1hZ2VMb2NhdGlvbixcbiAgICAgIGVuYWJsZUV4ZWN1dGU6IHBhcmFtZXRlcnMuZW5hYmxlRXhlY3V0ZSxcbiAgICAgIGRiU2VjcmV0OiB0aGlzLmRhdGFiYXNlLm1hc3RlclNlY3JldCxcbiAgICAgIGRiSG9zdG5hbWU6IHRoaXMuZGF0YWJhc2UuaG9zdG5hbWUsXG4gICAgICByZWRpc0F1dGhUb2tlbjogdGhpcy5yZWRpcy5hdXRoVG9rZW4sXG4gICAgICByZWRpc0hvc3RuYW1lOiB0aGlzLnJlZGlzLmhvc3RuYW1lLFxuICAgICAgc2VjcmV0S2V5OiB0aGlzLnNlY3JldHNNYW5hZ2VyLnNlY3JldEtleSxcbiAgICAgIGFkbWluVXNlclBhc3N3b3JkOiB0aGlzLnNlY3JldHNNYW5hZ2VyLmFkbWluVXNlclBhc3N3b3JkLFxuICAgICAgYWRtaW5Vc2VyVG9rZW46IHRoaXMuc2VjcmV0c01hbmFnZXIuYWRtaW5Vc2VyVG9rZW4sXG4gICAgICBsZGFwVG9rZW46IHRoaXMuc2VjcmV0c01hbmFnZXIubGRhcFRva2VuLFxuICAgICAgZWZzSWQ6IHRoaXMuZWZzLmZpbGVTeXN0ZW0uZmlsZVN5c3RlbUlkLFxuICAgICAgZWZzTWVkaWFBY2Nlc3NQb2ludElkOiB0aGlzLmVmcy5tZWRpYUFjY2Vzc1BvaW50LmFjY2Vzc1BvaW50SWQsXG4gICAgICBlZnNDdXN0b21UZW1wbGF0ZXNBY2Nlc3NQb2ludElkOiB0aGlzLmVmcy5jdXN0b21UZW1wbGF0ZXNBY2Nlc3NQb2ludC5hY2Nlc3NQb2ludElkXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgc3RhY2sgb3V0cHV0c1xuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgJ1N0YWNrTmFtZScsIHtcbiAgICAgIHZhbHVlOiB0aGlzLnN0YWNrTmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uOiAnTmFtZSBvZiB0aGUgZGVwbG95ZWQgc3RhY2snXG4gICAgfSk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsICdFbnZpcm9ubWVudCcsIHtcbiAgICAgIHZhbHVlOiBwcm9wcy5zdGFja05hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogJ0Vudmlyb25tZW50IG5hbWUnXG4gICAgfSk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsICdFbnZUeXBlJywge1xuICAgICAgdmFsdWU6IHByb3BzLmVudlR5cGUsXG4gICAgICBkZXNjcmlwdGlvbjogJ0Vudmlyb25tZW50IHR5cGUnXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==