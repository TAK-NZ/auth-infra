import { Stack, aws_ec2 as ec2, aws_ecs as ecs, aws_secretsmanager as secretsmanager, CfnOutput } from 'aws-cdk-lib';
import { importBaseInfraValue } from './stack-naming';
import { getEnvironmentConfig } from './environment-config';
import { Ldap } from './constructs/ldap';
/**
 * CDK stack for the LDAP outpost service
 */
export class LdapStack extends Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // Get environment configuration
        const config = getEnvironmentConfig(props.envType);
        // Import VPC from base infrastructure
        const vpc = ec2.Vpc.fromLookup(this, 'VPC', {
            vpcId: importBaseInfraValue(props.stackName, 'vpc-id')
        });
        // Import or create ECS cluster
        const ecsCluster = new ecs.Cluster(this, 'ECSCluster', {
            vpc,
            clusterName: `${id}-cluster`,
            enableFargateCapacityProviders: true
        });
        // Create security group for ECS tasks
        const ecsSecurityGroup = new ec2.SecurityGroup(this, 'ECSSecurityGroup', {
            vpc,
            description: 'Security group for LDAP ECS tasks',
            allowAllOutbound: true
        });
        // Allow LDAP and LDAPS traffic
        ecsSecurityGroup.addIngressRule(ec2.Peer.ipv4('10.0.0.0/8'), ec2.Port.tcp(389), 'Allow LDAP traffic');
        ecsSecurityGroup.addIngressRule(ec2.Peer.ipv4('10.0.0.0/8'), ec2.Port.tcp(636), 'Allow LDAPS traffic');
        // Import LDAP token secret from the auth infrastructure stack
        const ldapTokenSecretName = `tak-auth-infra-${props.stackName}/authentik-ldap-token`;
        const ldapToken = secretsmanager.Secret.fromSecretCompleteArn(this, 'LdapToken', `arn:aws:secretsmanager:${this.region}:${this.account}:secret:${ldapTokenSecretName}`);
        // Create default parameters (these would normally come from the app)
        const defaultParams = {
            gitSha: 'development',
            environment: props.stackName,
            envType: props.envType,
            enableExecute: false,
            sslCertificateArn: '',
            authentikHost: '',
            dockerImageLocation: 'Github'
        };
        // Merge with provided parameters
        const parameters = { ...defaultParams, ...(props.parameters || {}) };
        // Create LDAP construct
        this.ldap = new Ldap(this, 'LDAP', {
            environment: props.stackName,
            config,
            vpc,
            ecsSecurityGroup,
            ecsCluster,
            sslCertificateArn: parameters.sslCertificateArn,
            authentikHost: parameters.authentikHost,
            dockerImageLocation: parameters.dockerImageLocation,
            enableExecute: parameters.enableExecute,
            ldapToken
        });
        // Create stack outputs
        new CfnOutput(this, 'StackName', {
            value: this.stackName,
            description: 'Name of the deployed LDAP stack'
        });
        new CfnOutput(this, 'Environment', {
            value: props.stackName,
            description: 'Environment name'
        });
        new CfnOutput(this, 'EnvType', {
            value: props.envType,
            description: 'Environment type'
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGRhcC1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxkYXAtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUNMLEtBQUssRUFFTCxPQUFPLElBQUksR0FBRyxFQUNkLE9BQU8sSUFBSSxHQUFHLEVBQ2Qsa0JBQWtCLElBQUksY0FBYyxFQUNwQyxTQUFTLEVBQ1YsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFNUQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBc0J6Qzs7R0FFRztBQUNILE1BQU0sT0FBTyxTQUFVLFNBQVEsS0FBSztJQU1sQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXFCO1FBQzdELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLGdDQUFnQztRQUNoQyxNQUFNLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFbkQsc0NBQXNDO1FBQ3RDLE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUU7WUFDMUMsS0FBSyxFQUFFLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDO1NBQ3ZELENBQUMsQ0FBQztRQUVILCtCQUErQjtRQUMvQixNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRTtZQUNyRCxHQUFHO1lBQ0gsV0FBVyxFQUFFLEdBQUcsRUFBRSxVQUFVO1lBQzVCLDhCQUE4QixFQUFFLElBQUk7U0FDckMsQ0FBQyxDQUFDO1FBRUgsc0NBQXNDO1FBQ3RDLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUN2RSxHQUFHO1lBQ0gsV0FBVyxFQUFFLG1DQUFtQztZQUNoRCxnQkFBZ0IsRUFBRSxJQUFJO1NBQ3ZCLENBQUMsQ0FBQztRQUVILCtCQUErQjtRQUMvQixnQkFBZ0IsQ0FBQyxjQUFjLENBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUMzQixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFDakIsb0JBQW9CLENBQ3JCLENBQUM7UUFFRixnQkFBZ0IsQ0FBQyxjQUFjLENBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUMzQixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFDakIscUJBQXFCLENBQ3RCLENBQUM7UUFFRiw4REFBOEQ7UUFDOUQsTUFBTSxtQkFBbUIsR0FBRyxrQkFBa0IsS0FBSyxDQUFDLFNBQVMsdUJBQXVCLENBQUM7UUFDckYsTUFBTSxTQUFTLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FDM0QsSUFBSSxFQUNKLFdBQVcsRUFDWCwwQkFBMEIsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxXQUFXLG1CQUFtQixFQUFFLENBQ3RGLENBQUM7UUFFRixxRUFBcUU7UUFDckUsTUFBTSxhQUFhLEdBQW1CO1lBQ3BDLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLFdBQVcsRUFBRSxLQUFLLENBQUMsU0FBUztZQUM1QixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDdEIsYUFBYSxFQUFFLEtBQUs7WUFDcEIsaUJBQWlCLEVBQUUsRUFBRTtZQUNyQixhQUFhLEVBQUUsRUFBRTtZQUNqQixtQkFBbUIsRUFBRSxRQUFRO1NBQzlCLENBQUM7UUFFRixpQ0FBaUM7UUFDakMsTUFBTSxVQUFVLEdBQUcsRUFBRSxHQUFHLGFBQWEsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRXJFLHdCQUF3QjtRQUN4QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUU7WUFDakMsV0FBVyxFQUFFLEtBQUssQ0FBQyxTQUFTO1lBQzVCLE1BQU07WUFDTixHQUFHO1lBQ0gsZ0JBQWdCO1lBQ2hCLFVBQVU7WUFDVixpQkFBaUIsRUFBRSxVQUFVLENBQUMsaUJBQWlCO1lBQy9DLGFBQWEsRUFBRSxVQUFVLENBQUMsYUFBYTtZQUN2QyxtQkFBbUIsRUFBRSxVQUFVLENBQUMsbUJBQW1CO1lBQ25ELGFBQWEsRUFBRSxVQUFVLENBQUMsYUFBYTtZQUN2QyxTQUFTO1NBQ1YsQ0FBQyxDQUFDO1FBRUgsdUJBQXVCO1FBQ3ZCLElBQUksU0FBUyxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUU7WUFDL0IsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3JCLFdBQVcsRUFBRSxpQ0FBaUM7U0FDL0MsQ0FBQyxDQUFDO1FBRUgsSUFBSSxTQUFTLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtZQUNqQyxLQUFLLEVBQUUsS0FBSyxDQUFDLFNBQVM7WUFDdEIsV0FBVyxFQUFFLGtCQUFrQjtTQUNoQyxDQUFDLENBQUM7UUFFSCxJQUFJLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1lBQzdCLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTztZQUNwQixXQUFXLEVBQUUsa0JBQWtCO1NBQ2hDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTERBUCBTdGFjayAtIENESyBpbXBsZW1lbnRhdGlvbiBmb3IgQXV0aGVudGlrIExEQVAgb3V0cG9zdFxuICovXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIFN0YWNrLFxuICBTdGFja1Byb3BzLFxuICBhd3NfZWMyIGFzIGVjMixcbiAgYXdzX2VjcyBhcyBlY3MsXG4gIGF3c19zZWNyZXRzbWFuYWdlciBhcyBzZWNyZXRzbWFuYWdlcixcbiAgQ2ZuT3V0cHV0XG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IGltcG9ydEJhc2VJbmZyYVZhbHVlIH0gZnJvbSAnLi9zdGFjay1uYW1pbmcnO1xuaW1wb3J0IHsgZ2V0RW52aXJvbm1lbnRDb25maWcgfSBmcm9tICcuL2Vudmlyb25tZW50LWNvbmZpZyc7XG5pbXBvcnQgeyBMZGFwUGFyYW1ldGVycyB9IGZyb20gJy4vcGFyYW1ldGVycyc7XG5pbXBvcnQgeyBMZGFwIH0gZnJvbSAnLi9jb25zdHJ1Y3RzL2xkYXAnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBMREFQIFN0YWNrXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTGRhcFN0YWNrUHJvcHMgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgLyoqXG4gICAqIFN0YWNrIG5hbWUvZW52aXJvbm1lbnRcbiAgICovXG4gIHN0YWNrTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBFbnZpcm9ubWVudCB0eXBlXG4gICAqL1xuICBlbnZUeXBlOiAncHJvZCcgfCAnZGV2LXRlc3QnO1xuXG4gIC8qKlxuICAgKiBPcHRpb25hbCBwYXJhbWV0ZXJzIG92ZXJyaWRlXG4gICAqL1xuICBwYXJhbWV0ZXJzPzogUGFydGlhbDxMZGFwUGFyYW1ldGVycz47XG59XG5cbi8qKlxuICogQ0RLIHN0YWNrIGZvciB0aGUgTERBUCBvdXRwb3N0IHNlcnZpY2VcbiAqL1xuZXhwb3J0IGNsYXNzIExkYXBTdGFjayBleHRlbmRzIFN0YWNrIHtcbiAgLyoqXG4gICAqIFRoZSBMREFQIGNvbnN0cnVjdFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGxkYXA6IExkYXA7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IExkYXBTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICAvLyBHZXQgZW52aXJvbm1lbnQgY29uZmlndXJhdGlvblxuICAgIGNvbnN0IGNvbmZpZyA9IGdldEVudmlyb25tZW50Q29uZmlnKHByb3BzLmVudlR5cGUpO1xuXG4gICAgLy8gSW1wb3J0IFZQQyBmcm9tIGJhc2UgaW5mcmFzdHJ1Y3R1cmVcbiAgICBjb25zdCB2cGMgPSBlYzIuVnBjLmZyb21Mb29rdXAodGhpcywgJ1ZQQycsIHtcbiAgICAgIHZwY0lkOiBpbXBvcnRCYXNlSW5mcmFWYWx1ZShwcm9wcy5zdGFja05hbWUsICd2cGMtaWQnKVxuICAgIH0pO1xuXG4gICAgLy8gSW1wb3J0IG9yIGNyZWF0ZSBFQ1MgY2x1c3RlclxuICAgIGNvbnN0IGVjc0NsdXN0ZXIgPSBuZXcgZWNzLkNsdXN0ZXIodGhpcywgJ0VDU0NsdXN0ZXInLCB7XG4gICAgICB2cGMsXG4gICAgICBjbHVzdGVyTmFtZTogYCR7aWR9LWNsdXN0ZXJgLFxuICAgICAgZW5hYmxlRmFyZ2F0ZUNhcGFjaXR5UHJvdmlkZXJzOiB0cnVlXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgc2VjdXJpdHkgZ3JvdXAgZm9yIEVDUyB0YXNrc1xuICAgIGNvbnN0IGVjc1NlY3VyaXR5R3JvdXAgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAodGhpcywgJ0VDU1NlY3VyaXR5R3JvdXAnLCB7XG4gICAgICB2cGMsXG4gICAgICBkZXNjcmlwdGlvbjogJ1NlY3VyaXR5IGdyb3VwIGZvciBMREFQIEVDUyB0YXNrcycsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlXG4gICAgfSk7XG5cbiAgICAvLyBBbGxvdyBMREFQIGFuZCBMREFQUyB0cmFmZmljXG4gICAgZWNzU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGVjMi5QZWVyLmlwdjQoJzEwLjAuMC4wLzgnKSxcbiAgICAgIGVjMi5Qb3J0LnRjcCgzODkpLFxuICAgICAgJ0FsbG93IExEQVAgdHJhZmZpYydcbiAgICApO1xuXG4gICAgZWNzU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGVjMi5QZWVyLmlwdjQoJzEwLjAuMC4wLzgnKSxcbiAgICAgIGVjMi5Qb3J0LnRjcCg2MzYpLFxuICAgICAgJ0FsbG93IExEQVBTIHRyYWZmaWMnXG4gICAgKTtcblxuICAgIC8vIEltcG9ydCBMREFQIHRva2VuIHNlY3JldCBmcm9tIHRoZSBhdXRoIGluZnJhc3RydWN0dXJlIHN0YWNrXG4gICAgY29uc3QgbGRhcFRva2VuU2VjcmV0TmFtZSA9IGB0YWstYXV0aC1pbmZyYS0ke3Byb3BzLnN0YWNrTmFtZX0vYXV0aGVudGlrLWxkYXAtdG9rZW5gO1xuICAgIGNvbnN0IGxkYXBUb2tlbiA9IHNlY3JldHNtYW5hZ2VyLlNlY3JldC5mcm9tU2VjcmV0Q29tcGxldGVBcm4oXG4gICAgICB0aGlzLCBcbiAgICAgICdMZGFwVG9rZW4nLCBcbiAgICAgIGBhcm46YXdzOnNlY3JldHNtYW5hZ2VyOiR7dGhpcy5yZWdpb259OiR7dGhpcy5hY2NvdW50fTpzZWNyZXQ6JHtsZGFwVG9rZW5TZWNyZXROYW1lfWBcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIGRlZmF1bHQgcGFyYW1ldGVycyAodGhlc2Ugd291bGQgbm9ybWFsbHkgY29tZSBmcm9tIHRoZSBhcHApXG4gICAgY29uc3QgZGVmYXVsdFBhcmFtczogTGRhcFBhcmFtZXRlcnMgPSB7XG4gICAgICBnaXRTaGE6ICdkZXZlbG9wbWVudCcsXG4gICAgICBlbnZpcm9ubWVudDogcHJvcHMuc3RhY2tOYW1lLFxuICAgICAgZW52VHlwZTogcHJvcHMuZW52VHlwZSxcbiAgICAgIGVuYWJsZUV4ZWN1dGU6IGZhbHNlLFxuICAgICAgc3NsQ2VydGlmaWNhdGVBcm46ICcnLFxuICAgICAgYXV0aGVudGlrSG9zdDogJycsXG4gICAgICBkb2NrZXJJbWFnZUxvY2F0aW9uOiAnR2l0aHViJ1xuICAgIH07XG5cbiAgICAvLyBNZXJnZSB3aXRoIHByb3ZpZGVkIHBhcmFtZXRlcnNcbiAgICBjb25zdCBwYXJhbWV0ZXJzID0geyAuLi5kZWZhdWx0UGFyYW1zLCAuLi4ocHJvcHMucGFyYW1ldGVycyB8fCB7fSkgfTtcblxuICAgIC8vIENyZWF0ZSBMREFQIGNvbnN0cnVjdFxuICAgIHRoaXMubGRhcCA9IG5ldyBMZGFwKHRoaXMsICdMREFQJywge1xuICAgICAgZW52aXJvbm1lbnQ6IHByb3BzLnN0YWNrTmFtZSxcbiAgICAgIGNvbmZpZyxcbiAgICAgIHZwYyxcbiAgICAgIGVjc1NlY3VyaXR5R3JvdXAsXG4gICAgICBlY3NDbHVzdGVyLFxuICAgICAgc3NsQ2VydGlmaWNhdGVBcm46IHBhcmFtZXRlcnMuc3NsQ2VydGlmaWNhdGVBcm4sXG4gICAgICBhdXRoZW50aWtIb3N0OiBwYXJhbWV0ZXJzLmF1dGhlbnRpa0hvc3QsXG4gICAgICBkb2NrZXJJbWFnZUxvY2F0aW9uOiBwYXJhbWV0ZXJzLmRvY2tlckltYWdlTG9jYXRpb24sXG4gICAgICBlbmFibGVFeGVjdXRlOiBwYXJhbWV0ZXJzLmVuYWJsZUV4ZWN1dGUsXG4gICAgICBsZGFwVG9rZW5cbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBzdGFjayBvdXRwdXRzXG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCAnU3RhY2tOYW1lJywge1xuICAgICAgdmFsdWU6IHRoaXMuc3RhY2tOYW1lLFxuICAgICAgZGVzY3JpcHRpb246ICdOYW1lIG9mIHRoZSBkZXBsb3llZCBMREFQIHN0YWNrJ1xuICAgIH0pO1xuXG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCAnRW52aXJvbm1lbnQnLCB7XG4gICAgICB2YWx1ZTogcHJvcHMuc3RhY2tOYW1lLFxuICAgICAgZGVzY3JpcHRpb246ICdFbnZpcm9ubWVudCBuYW1lJ1xuICAgIH0pO1xuXG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCAnRW52VHlwZScsIHtcbiAgICAgIHZhbHVlOiBwcm9wcy5lbnZUeXBlLFxuICAgICAgZGVzY3JpcHRpb246ICdFbnZpcm9ubWVudCB0eXBlJ1xuICAgIH0pO1xuICB9XG59XG4iXX0=