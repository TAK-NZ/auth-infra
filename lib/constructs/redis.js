"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Redis = void 0;
/**
 * Redis Construct - CDK implementation of the Redis/Valkey cache
 */
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
/**
 * CDK construct for the Redis/Valkey cache cluster
 */
class Redis extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Derive environment-specific values from context (matches reference pattern)
        const isHighAvailability = props.environment === 'prod';
        const automaticFailoverEnabled = props.contextConfig.redis.numCacheNodes > 1;
        // Create the auth token secret
        this.authToken = new aws_cdk_lib_1.aws_secretsmanager.Secret(this, 'RedisAuthToken', {
            description: `${id}: Auth Token`,
            secretName: `${props.stackName}/Redis/Auth-Token`,
            encryptionKey: props.infrastructure.kmsKey,
            generateSecretString: {
                excludePunctuation: true,
                passwordLength: 64
            }
        });
        // Create subnet group
        const subnetGroup = new aws_cdk_lib_1.aws_elasticache.CfnSubnetGroup(this, 'RedisSubnetGroup', {
            description: `${id}-redis-subnets`,
            subnetIds: props.infrastructure.vpc.privateSubnets.map(subnet => subnet.subnetId)
        });
        // Create security group
        const securityGroup = new aws_cdk_lib_1.aws_ec2.SecurityGroup(this, '-SecurityGroup', {
            vpc: props.infrastructure.vpc,
            description: `${id} Security Group`,
            allowAllOutbound: false
        });
        // Allow Redis port from other security groups
        props.securityGroups.forEach(sg => {
            securityGroup.addIngressRule(aws_cdk_lib_1.aws_ec2.Peer.securityGroupId(sg.securityGroupId), aws_cdk_lib_1.aws_ec2.Port.tcp(6379), 'Allow Redis access from ECS tasks');
        });
        // Create the Redis replication group
        this.replicationGroup = new aws_cdk_lib_1.aws_elasticache.CfnReplicationGroup(this, 'Redis', {
            replicationGroupDescription: 'Valkey (Redis) cluster for Authentik',
            automaticFailoverEnabled: automaticFailoverEnabled,
            atRestEncryptionEnabled: true,
            transitEncryptionEnabled: true,
            transitEncryptionMode: 'required',
            authToken: this.authToken.secretValue.unsafeUnwrap(),
            kmsKeyId: props.infrastructure.kmsKey.keyArn,
            cacheNodeType: props.contextConfig.redis.nodeType,
            cacheSubnetGroupName: subnetGroup.ref,
            engine: 'valkey',
            engineVersion: '7.2',
            autoMinorVersionUpgrade: true,
            numCacheClusters: props.contextConfig.redis.numCacheNodes,
            securityGroupIds: [securityGroup.securityGroupId]
        });
        // Set dependencies
        this.replicationGroup.addDependency(subnetGroup);
        // Store the hostname
        this.hostname = this.replicationGroup.attrPrimaryEndPointAddress;
    }
}
exports.Redis = Redis;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWRpcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQTs7R0FFRztBQUNILDJDQUF1QztBQUN2Qyw2Q0FLcUI7QUFtQ3JCOztHQUVHO0FBQ0gsTUFBYSxLQUFNLFNBQVEsc0JBQVM7SUFnQmxDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBaUI7UUFDekQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQiw4RUFBOEU7UUFDOUUsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUMsV0FBVyxLQUFLLE1BQU0sQ0FBQztRQUN4RCxNQUFNLHdCQUF3QixHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFFN0UsK0JBQStCO1FBQy9CLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDakUsV0FBVyxFQUFFLEdBQUcsRUFBRSxjQUFjO1lBQ2hDLFVBQVUsRUFBRSxHQUFHLEtBQUssQ0FBQyxTQUFTLG1CQUFtQjtZQUNqRCxhQUFhLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxNQUFNO1lBQzFDLG9CQUFvQixFQUFFO2dCQUNwQixrQkFBa0IsRUFBRSxJQUFJO2dCQUN4QixjQUFjLEVBQUUsRUFBRTthQUNuQjtTQUNGLENBQUMsQ0FBQztRQUVILHNCQUFzQjtRQUN0QixNQUFNLFdBQVcsR0FBRyxJQUFJLDZCQUFXLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUMzRSxXQUFXLEVBQUUsR0FBRyxFQUFFLGdCQUFnQjtZQUNsQyxTQUFTLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7U0FDbEYsQ0FBQyxDQUFDO1FBRUgsd0JBQXdCO1FBQ3hCLE1BQU0sYUFBYSxHQUFHLElBQUkscUJBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQ2xFLEdBQUcsRUFBRSxLQUFLLENBQUMsY0FBYyxDQUFDLEdBQUc7WUFDN0IsV0FBVyxFQUFFLEdBQUcsRUFBRSxpQkFBaUI7WUFDbkMsZ0JBQWdCLEVBQUUsS0FBSztTQUN4QixDQUFDLENBQUM7UUFFSCw4Q0FBOEM7UUFDOUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDaEMsYUFBYSxDQUFDLGNBQWMsQ0FDMUIscUJBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFDNUMscUJBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUNsQixtQ0FBbUMsQ0FDcEMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgscUNBQXFDO1FBQ3JDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLDZCQUFXLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRTtZQUN6RSwyQkFBMkIsRUFBRSxzQ0FBc0M7WUFDbkUsd0JBQXdCLEVBQUUsd0JBQXdCO1lBQ2xELHVCQUF1QixFQUFFLElBQUk7WUFDN0Isd0JBQXdCLEVBQUUsSUFBSTtZQUM5QixxQkFBcUIsRUFBRSxVQUFVO1lBQ2pDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUU7WUFDcEQsUUFBUSxFQUFFLEtBQUssQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE1BQU07WUFDNUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLFFBQVE7WUFDakQsb0JBQW9CLEVBQUUsV0FBVyxDQUFDLEdBQUc7WUFDckMsTUFBTSxFQUFFLFFBQVE7WUFDaEIsYUFBYSxFQUFFLEtBQUs7WUFDcEIsdUJBQXVCLEVBQUUsSUFBSTtZQUM3QixnQkFBZ0IsRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxhQUFhO1lBQ3pELGdCQUFnQixFQUFFLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQztTQUNsRCxDQUFDLENBQUM7UUFFSCxtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVqRCxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsMEJBQTBCLENBQUM7SUFDbkUsQ0FBQztDQUNGO0FBaEZELHNCQWdGQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmVkaXMgQ29uc3RydWN0IC0gQ0RLIGltcGxlbWVudGF0aW9uIG9mIHRoZSBSZWRpcy9WYWxrZXkgY2FjaGVcbiAqL1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQge1xuICBhd3NfZWxhc3RpY2FjaGUgYXMgZWxhc3RpY2FjaGUsXG4gIGF3c19lYzIgYXMgZWMyLFxuICBhd3Nfc2VjcmV0c21hbmFnZXIgYXMgc2VjcmV0c21hbmFnZXIsXG4gIGF3c19rbXMgYXMga21zXG59IGZyb20gJ2F3cy1jZGstbGliJztcblxuaW1wb3J0IHR5cGUgeyBDb250ZXh0RW52aXJvbm1lbnRDb25maWcgfSBmcm9tICcuLi9zdGFjay1jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBJbmZyYXN0cnVjdHVyZUNvbmZpZyB9IGZyb20gJy4uL2NvbnN0cnVjdC1jb25maWdzJztcblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciB0aGUgUmVkaXMgY29uc3RydWN0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmVkaXNQcm9wcyB7XG4gIC8qKlxuICAgKiBFbnZpcm9ubWVudCB0eXBlICgncHJvZCcgfCAnZGV2LXRlc3QnKVxuICAgKi9cbiAgZW52aXJvbm1lbnQ6ICdwcm9kJyB8ICdkZXYtdGVzdCc7XG5cbiAgLyoqXG4gICAqIEZ1bGwgc3RhY2sgbmFtZSAoZS5nLiwgJ1RBSy1EZW1vLUF1dGhJbmZyYScpXG4gICAqL1xuICBzdGFja05hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogQ29udGV4dC1iYXNlZCBlbnZpcm9ubWVudCBjb25maWd1cmF0aW9uIChkaXJlY3QgZnJvbSBjZGsuanNvbilcbiAgICovXG4gIGNvbnRleHRDb25maWc6IENvbnRleHRFbnZpcm9ubWVudENvbmZpZztcblxuICAvKipcbiAgICogSW5mcmFzdHJ1Y3R1cmUgY29uZmlndXJhdGlvbiAoVlBDLCBLTVMsIHNlY3VyaXR5IGdyb3VwcylcbiAgICovXG4gIGluZnJhc3RydWN0dXJlOiBJbmZyYXN0cnVjdHVyZUNvbmZpZztcblxuICAvKipcbiAgICogU2VjdXJpdHkgZ3JvdXBzIGZvciBSZWRpcyBhY2Nlc3NcbiAgICovXG4gIHNlY3VyaXR5R3JvdXBzOiBlYzIuU2VjdXJpdHlHcm91cFtdO1xufVxuXG4vKipcbiAqIENESyBjb25zdHJ1Y3QgZm9yIHRoZSBSZWRpcy9WYWxrZXkgY2FjaGUgY2x1c3RlclxuICovXG5leHBvcnQgY2xhc3MgUmVkaXMgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAvKipcbiAgICogVGhlIGF1dGggdG9rZW4gc2VjcmV0IGZvciBSZWRpc1xuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGF1dGhUb2tlbjogc2VjcmV0c21hbmFnZXIuU2VjcmV0O1xuXG4gIC8qKlxuICAgKiBUaGUgUmVkaXMgcmVwbGljYXRpb24gZ3JvdXBcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSByZXBsaWNhdGlvbkdyb3VwOiBlbGFzdGljYWNoZS5DZm5SZXBsaWNhdGlvbkdyb3VwO1xuXG4gIC8qKlxuICAgKiBUaGUgUmVkaXMgaG9zdG5hbWVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBob3N0bmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBSZWRpc1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIERlcml2ZSBlbnZpcm9ubWVudC1zcGVjaWZpYyB2YWx1ZXMgZnJvbSBjb250ZXh0IChtYXRjaGVzIHJlZmVyZW5jZSBwYXR0ZXJuKVxuICAgIGNvbnN0IGlzSGlnaEF2YWlsYWJpbGl0eSA9IHByb3BzLmVudmlyb25tZW50ID09PSAncHJvZCc7XG4gICAgY29uc3QgYXV0b21hdGljRmFpbG92ZXJFbmFibGVkID0gcHJvcHMuY29udGV4dENvbmZpZy5yZWRpcy5udW1DYWNoZU5vZGVzID4gMTtcblxuICAgIC8vIENyZWF0ZSB0aGUgYXV0aCB0b2tlbiBzZWNyZXRcbiAgICB0aGlzLmF1dGhUb2tlbiA9IG5ldyBzZWNyZXRzbWFuYWdlci5TZWNyZXQodGhpcywgJ1JlZGlzQXV0aFRva2VuJywge1xuICAgICAgZGVzY3JpcHRpb246IGAke2lkfTogQXV0aCBUb2tlbmAsXG4gICAgICBzZWNyZXROYW1lOiBgJHtwcm9wcy5zdGFja05hbWV9L1JlZGlzL0F1dGgtVG9rZW5gLFxuICAgICAgZW5jcnlwdGlvbktleTogcHJvcHMuaW5mcmFzdHJ1Y3R1cmUua21zS2V5LFxuICAgICAgZ2VuZXJhdGVTZWNyZXRTdHJpbmc6IHtcbiAgICAgICAgZXhjbHVkZVB1bmN0dWF0aW9uOiB0cnVlLFxuICAgICAgICBwYXNzd29yZExlbmd0aDogNjRcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBzdWJuZXQgZ3JvdXBcbiAgICBjb25zdCBzdWJuZXRHcm91cCA9IG5ldyBlbGFzdGljYWNoZS5DZm5TdWJuZXRHcm91cCh0aGlzLCAnUmVkaXNTdWJuZXRHcm91cCcsIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgJHtpZH0tcmVkaXMtc3VibmV0c2AsXG4gICAgICBzdWJuZXRJZHM6IHByb3BzLmluZnJhc3RydWN0dXJlLnZwYy5wcml2YXRlU3VibmV0cy5tYXAoc3VibmV0ID0+IHN1Ym5ldC5zdWJuZXRJZClcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBzZWN1cml0eSBncm91cFxuICAgIGNvbnN0IHNlY3VyaXR5R3JvdXAgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAodGhpcywgJy1TZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjOiBwcm9wcy5pbmZyYXN0cnVjdHVyZS52cGMsXG4gICAgICBkZXNjcmlwdGlvbjogYCR7aWR9IFNlY3VyaXR5IEdyb3VwYCxcbiAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IGZhbHNlXG4gICAgfSk7XG5cbiAgICAvLyBBbGxvdyBSZWRpcyBwb3J0IGZyb20gb3RoZXIgc2VjdXJpdHkgZ3JvdXBzXG4gICAgcHJvcHMuc2VjdXJpdHlHcm91cHMuZm9yRWFjaChzZyA9PiB7XG4gICAgICBzZWN1cml0eUdyb3VwLmFkZEluZ3Jlc3NSdWxlKFxuICAgICAgICBlYzIuUGVlci5zZWN1cml0eUdyb3VwSWQoc2cuc2VjdXJpdHlHcm91cElkKSxcbiAgICAgICAgZWMyLlBvcnQudGNwKDYzNzkpLFxuICAgICAgICAnQWxsb3cgUmVkaXMgYWNjZXNzIGZyb20gRUNTIHRhc2tzJ1xuICAgICAgKTtcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSB0aGUgUmVkaXMgcmVwbGljYXRpb24gZ3JvdXBcbiAgICB0aGlzLnJlcGxpY2F0aW9uR3JvdXAgPSBuZXcgZWxhc3RpY2FjaGUuQ2ZuUmVwbGljYXRpb25Hcm91cCh0aGlzLCAnUmVkaXMnLCB7XG4gICAgICByZXBsaWNhdGlvbkdyb3VwRGVzY3JpcHRpb246ICdWYWxrZXkgKFJlZGlzKSBjbHVzdGVyIGZvciBBdXRoZW50aWsnLFxuICAgICAgYXV0b21hdGljRmFpbG92ZXJFbmFibGVkOiBhdXRvbWF0aWNGYWlsb3ZlckVuYWJsZWQsXG4gICAgICBhdFJlc3RFbmNyeXB0aW9uRW5hYmxlZDogdHJ1ZSxcbiAgICAgIHRyYW5zaXRFbmNyeXB0aW9uRW5hYmxlZDogdHJ1ZSxcbiAgICAgIHRyYW5zaXRFbmNyeXB0aW9uTW9kZTogJ3JlcXVpcmVkJyxcbiAgICAgIGF1dGhUb2tlbjogdGhpcy5hdXRoVG9rZW4uc2VjcmV0VmFsdWUudW5zYWZlVW53cmFwKCksXG4gICAgICBrbXNLZXlJZDogcHJvcHMuaW5mcmFzdHJ1Y3R1cmUua21zS2V5LmtleUFybixcbiAgICAgIGNhY2hlTm9kZVR5cGU6IHByb3BzLmNvbnRleHRDb25maWcucmVkaXMubm9kZVR5cGUsXG4gICAgICBjYWNoZVN1Ym5ldEdyb3VwTmFtZTogc3VibmV0R3JvdXAucmVmLFxuICAgICAgZW5naW5lOiAndmFsa2V5JyxcbiAgICAgIGVuZ2luZVZlcnNpb246ICc3LjInLFxuICAgICAgYXV0b01pbm9yVmVyc2lvblVwZ3JhZGU6IHRydWUsXG4gICAgICBudW1DYWNoZUNsdXN0ZXJzOiBwcm9wcy5jb250ZXh0Q29uZmlnLnJlZGlzLm51bUNhY2hlTm9kZXMsXG4gICAgICBzZWN1cml0eUdyb3VwSWRzOiBbc2VjdXJpdHlHcm91cC5zZWN1cml0eUdyb3VwSWRdXG4gICAgfSk7XG5cbiAgICAvLyBTZXQgZGVwZW5kZW5jaWVzXG4gICAgdGhpcy5yZXBsaWNhdGlvbkdyb3VwLmFkZERlcGVuZGVuY3koc3VibmV0R3JvdXApO1xuXG4gICAgLy8gU3RvcmUgdGhlIGhvc3RuYW1lXG4gICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMucmVwbGljYXRpb25Hcm91cC5hdHRyUHJpbWFyeUVuZFBvaW50QWRkcmVzcztcbiAgfVxufVxuIl19