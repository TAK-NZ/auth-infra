{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.200.2"},"children":{"TAK-Demo-AuthInfra":{"id":"TAK-Demo-AuthInfra","path":"TAK-Demo-AuthInfra","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.200.2"},"children":{"VPC":{"id":"VPC","path":"TAK-Demo-AuthInfra/VPC","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]},"children":{"PublicSubnet1":{"id":"PublicSubnet1","path":"TAK-Demo-AuthInfra/VPC/PublicSubnet1","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"PublicSubnet2":{"id":"PublicSubnet2","path":"TAK-Demo-AuthInfra/VPC/PublicSubnet2","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"PrivateSubnet1":{"id":"PrivateSubnet1","path":"TAK-Demo-AuthInfra/VPC/PrivateSubnet1","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"PrivateSubnet2":{"id":"PrivateSubnet2","path":"TAK-Demo-AuthInfra/VPC/PrivateSubnet2","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}}}},"KMSKey":{"id":"KMSKey","path":"TAK-Demo-AuthInfra/KMSKey","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"ECSCluster":{"id":"ECSCluster","path":"TAK-Demo-AuthInfra/ECSCluster","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"S3ConfBucket":{"id":"S3ConfBucket","path":"TAK-Demo-AuthInfra/S3ConfBucket","constructInfo":{"fqn":"aws-cdk-lib.aws_s3.BucketBase","version":"2.200.2","metadata":[]}},"ECSSecurityGroup":{"id":"ECSSecurityGroup","path":"TAK-Demo-AuthInfra/ECSSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/ECSSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Security group for ECS tasks","securityGroupEgress":[{"cidrIp":"0.0.0.0/0","description":"Allow all outbound traffic by default","ipProtocol":"-1"}],"securityGroupIngress":[{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":80,"toPort":80,"description":"Allow HTTP traffic"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":443,"toPort":443,"description":"Allow HTTPS traffic"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":9000,"toPort":9000,"description":"Allow Authentik traffic"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}},"from TAKDemoAuthInfraAuthentikELBALBSecurityGroupFB6F6CF0:9000":{"id":"from TAKDemoAuthInfraAuthentikELBALBSecurityGroupFB6F6CF0:9000","path":"TAK-Demo-AuthInfra/ECSSecurityGroup/from TAKDemoAuthInfraAuthentikELBALBSecurityGroupFB6F6CF0:9000","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroupIngress","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroupIngress","aws:cdk:cloudformation:props":{"description":"Load balancer to target","fromPort":9000,"groupId":{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]},"ipProtocol":"tcp","sourceSecurityGroupId":{"Fn::GetAtt":["AuthentikELBALBSecurityGroup6E7316BD","GroupId"]},"toPort":9000}}}}},"DBSecurityGroup":{"id":"DBSecurityGroup","path":"TAK-Demo-AuthInfra/DBSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/DBSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Security group for database","securityGroupEgress":[{"cidrIp":"255.255.255.255/32","description":"Disallow all traffic","ipProtocol":"icmp","fromPort":252,"toPort":86}],"securityGroupIngress":[{"sourceSecurityGroupId":{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]},"ipProtocol":"tcp","fromPort":5432,"toPort":5432,"description":"Allow PostgreSQL access from ECS tasks"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}},"SecretsManager":{"id":"SecretsManager","path":"TAK-Demo-AuthInfra/SecretsManager","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"AuthentikSecretKey":{"id":"AuthentikSecretKey","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikSecretKey","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikSecretKey/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Authentik: Secret Key","generateSecretString":{"excludePunctuation":true,"passwordLength":64},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Authentik/Secret-Key","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"AuthentikAdminUserPassword":{"id":"AuthentikAdminUserPassword","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikAdminUserPassword","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikAdminUserPassword/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Authentik: Admin Password","generateSecretString":{"secretStringTemplate":"{\"username\":\"akadmin\"}","generateStringKey":"password","excludePunctuation":true,"passwordLength":32},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Authentik/Admin-Password","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"AuthentikAdminUserToken":{"id":"AuthentikAdminUserToken","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikAdminUserToken","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikAdminUserToken/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Authentik: Admin API Token","generateSecretString":{"excludePunctuation":true,"passwordLength":64},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Authentik/Admin-API-Token","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"AuthentikLDAPServiceUser":{"id":"AuthentikLDAPServiceUser","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikLDAPServiceUser","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikLDAPServiceUser/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Authentik: LDAP Service User","generateSecretString":{"secretStringTemplate":"{\"username\":\"ldapservice\"}","generateStringKey":"password","excludePunctuation":true,"passwordLength":32},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Authentik/LDAP-Service-User","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"AuthentikLDAPToken":{"id":"AuthentikLDAPToken","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikLDAPToken","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikLDAPToken/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Authentik: LDAP Outpost Token","kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Authentik/LDAP-Token","secretString":"replace-me","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"AuthentikSecretKeyArn":{"id":"AuthentikSecretKeyArn","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikSecretKeyArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikAdminUserPasswordArn":{"id":"AuthentikAdminUserPasswordArn","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikAdminUserPasswordArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikAdminUserTokenArn":{"id":"AuthentikAdminUserTokenArn","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikAdminUserTokenArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikLDAPServiceUserArn":{"id":"AuthentikLDAPServiceUserArn","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikLDAPServiceUserArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikLDAPTokenArn":{"id":"AuthentikLDAPTokenArn","path":"TAK-Demo-AuthInfra/SecretsManager/AuthentikLDAPTokenArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}}}},"Database":{"id":"Database","path":"TAK-Demo-AuthInfra/Database","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"DBMasterSecret":{"id":"DBMasterSecret","path":"TAK-Demo-AuthInfra/Database/DBMasterSecret","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBMasterSecret/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Database: PostgreSQL Master Password","generateSecretString":{"secretStringTemplate":"{\"username\":\"authentik\"}","generateStringKey":"password","excludePunctuation":true,"passwordLength":64},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Database/Master-Password","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"Attachment":{"id":"Attachment","path":"TAK-Demo-AuthInfra/Database/DBMasterSecret/Attachment","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.SecretTargetAttachment","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBMasterSecret/Attachment/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecretTargetAttachment","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::SecretTargetAttachment","aws:cdk:cloudformation:props":{"secretId":{"Ref":"DatabaseDBMasterSecret1B2A26AA"},"targetId":{"Ref":"DatabaseDBCluster27FBE994"},"targetType":"AWS::RDS::DBCluster"}}}}}}},"DBMonitoringRole":{"id":"DBMonitoringRole","path":"TAK-Demo-AuthInfra/Database/DBMonitoringRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportDBMonitoringRole":{"id":"ImportDBMonitoringRole","path":"TAK-Demo-AuthInfra/Database/DBMonitoringRole/ImportDBMonitoringRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBMonitoringRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"monitoring.rds.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"]]}],"path":"/","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"DBSubnetGroup":{"id":"DBSubnetGroup","path":"TAK-Demo-AuthInfra/Database/DBSubnetGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.SubnetGroup","version":"2.200.2","metadata":[]},"children":{"Default":{"id":"Default","path":"TAK-Demo-AuthInfra/Database/DBSubnetGroup/Default","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.CfnDBSubnetGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::RDS::DBSubnetGroup","aws:cdk:cloudformation:props":{"dbSubnetGroupDescription":"Database database subnet group","subnetIds":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"DBParameterGroup":{"id":"DBParameterGroup","path":"TAK-Demo-AuthInfra/Database/DBParameterGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.ParameterGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBParameterGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.CfnDBClusterParameterGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::RDS::DBClusterParameterGroup","aws:cdk:cloudformation:props":{"description":"Database cluster parameter group","family":"aurora-postgresql17","parameters":{"shared_preload_libraries":"pg_stat_statements","log_statement":"all","log_min_duration_statement":"1000","log_connections":"1","log_disconnections":"1"},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"DBCluster":{"id":"DBCluster","path":"TAK-Demo-AuthInfra/Database/DBCluster","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.DatabaseCluster","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBCluster/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.CfnDBCluster","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::RDS::DBCluster","aws:cdk:cloudformation:props":{"backupRetentionPeriod":1,"copyTagsToSnapshot":true,"databaseName":"authentik","dbClusterParameterGroupName":{"Ref":"DatabaseDBParameterGroup7E4DF99E"},"dbSubnetGroupName":{"Ref":"DatabaseDBSubnetGroupD90D34CC"},"deletionProtection":false,"enableCloudwatchLogsExports":["postgresql"],"engine":"aurora-postgresql","engineVersion":"17.4","kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"masterUsername":{"Fn::Join":["",["{{resolve:secretsmanager:",{"Ref":"DatabaseDBMasterSecret1B2A26AA"},":SecretString:username::}}"]]},"masterUserPassword":{"Fn::Join":["",["{{resolve:secretsmanager:",{"Ref":"DatabaseDBMasterSecret1B2A26AA"},":SecretString:password::}}"]]},"port":5432,"serverlessV2ScalingConfiguration":{"minCapacity":0.5,"maxCapacity":4},"storageEncrypted":true,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcSecurityGroupIds":[{"Fn::GetAtt":["DBSecurityGroupE3B245A3","GroupId"]}]}}},"LogRetentionpostgresql":{"id":"LogRetentionpostgresql","path":"TAK-Demo-AuthInfra/Database/DBCluster/LogRetentionpostgresql","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogRetention","version":"2.200.2"},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBCluster/LogRetentionpostgresql/Resource","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.200.2"}}}},"LogGroup${Token[TOKEN.243]}postgresql":{"id":"LogGroup${Token[TOKEN.243]}postgresql","path":"TAK-Demo-AuthInfra/Database/DBCluster/LogGroup${Token[TOKEN.243]}postgresql","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"writer":{"id":"writer","path":"TAK-Demo-AuthInfra/Database/DBCluster/writer","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Database/DBCluster/writer/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_rds.CfnDBInstance","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::RDS::DBInstance","aws:cdk:cloudformation:props":{"dbClusterIdentifier":{"Ref":"DatabaseDBCluster27FBE994"},"dbInstanceClass":"db.serverless","engine":"aurora-postgresql","promotionTier":0,"publiclyAccessible":false,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}}}},"DatabaseEndpoint":{"id":"DatabaseEndpoint","path":"TAK-Demo-AuthInfra/Database/DatabaseEndpoint","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"DatabaseSecretArn":{"id":"DatabaseSecretArn","path":"TAK-Demo-AuthInfra/Database/DatabaseSecretArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}}}},"LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a":{"id":"LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Code":{"id":"Code","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/Code","constructInfo":{"fqn":"aws-cdk-lib.aws_s3_assets.Asset","version":"2.200.2"},"children":{"Stage":{"id":"Stage","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/Code/Stage","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"2.200.2"}},"AssetBucket":{"id":"AssetBucket","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/Code/AssetBucket","constructInfo":{"fqn":"aws-cdk-lib.aws_s3.BucketBase","version":"2.200.2","metadata":[]}}}},"ServiceRole":{"id":"ServiceRole","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["logs:DeleteRetentionPolicy","logs:PutRetentionPolicy"],"Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"},"policyName":"LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB","roles":[{"Ref":"LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB"}]}}}}}}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/Resource","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.200.2"}}}},"Redis":{"id":"Redis","path":"TAK-Demo-AuthInfra/Redis","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"RedisAuthToken":{"id":"RedisAuthToken","path":"TAK-Demo-AuthInfra/Redis/RedisAuthToken","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.Secret","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Redis/RedisAuthToken/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_secretsmanager.CfnSecret","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SecretsManager::Secret","aws:cdk:cloudformation:props":{"description":"Redis: Auth Token","generateSecretString":{"excludePunctuation":true,"passwordLength":64},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"name":"TAK-Demo-AuthInfra/Redis/Auth-Token","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"RedisSubnetGroup":{"id":"RedisSubnetGroup","path":"TAK-Demo-AuthInfra/Redis/RedisSubnetGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticache.CfnSubnetGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElastiCache::SubnetGroup","aws:cdk:cloudformation:props":{"description":"Redis-redis-subnets","subnetIds":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"RedisSecurityGroup":{"id":"RedisSecurityGroup","path":"TAK-Demo-AuthInfra/Redis/RedisSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Redis/RedisSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Redis Redis Security Group","securityGroupEgress":[{"cidrIp":"255.255.255.255/32","description":"Disallow all traffic","ipProtocol":"icmp","fromPort":252,"toPort":86}],"securityGroupIngress":[{"sourceSecurityGroupId":{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]},"ipProtocol":"tcp","fromPort":6379,"toPort":6379,"description":"Allow Redis access from ECS tasks"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}},"Redis":{"id":"Redis","path":"TAK-Demo-AuthInfra/Redis/Redis","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticache.CfnReplicationGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElastiCache::ReplicationGroup","aws:cdk:cloudformation:props":{"atRestEncryptionEnabled":true,"authToken":{"Fn::Join":["",["{{resolve:secretsmanager:",{"Ref":"RedisRedisAuthTokenAC379C8C"},":SecretString:::}}"]]},"automaticFailoverEnabled":false,"autoMinorVersionUpgrade":true,"cacheNodeType":"cache.t4g.micro","cacheSubnetGroupName":{"Ref":"RedisRedisSubnetGroupE7D796E2"},"engine":"valkey","engineVersion":"7.2","kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"numCacheClusters":1,"replicationGroupDescription":"Valkey (Redis) cluster for Authentik","securityGroupIds":[{"Fn::GetAtt":["RedisRedisSecurityGroup23991694","GroupId"]}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"transitEncryptionEnabled":true,"transitEncryptionMode":"required"}}},"RedisEndpoint":{"id":"RedisEndpoint","path":"TAK-Demo-AuthInfra/Redis/RedisEndpoint","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"RedisAuthTokenArn":{"id":"RedisAuthTokenArn","path":"TAK-Demo-AuthInfra/Redis/RedisAuthTokenArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}}}},"EFS":{"id":"EFS","path":"TAK-Demo-AuthInfra/EFS","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"EFSMountTargetSecurityGroup":{"id":"EFSMountTargetSecurityGroup","path":"TAK-Demo-AuthInfra/EFS/EFSMountTargetSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EFS/EFSMountTargetSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"EFS to Auth ECS Service","securityGroupEgress":[{"cidrIp":"255.255.255.255/32","description":"Disallow all traffic","ipProtocol":"icmp","fromPort":252,"toPort":86}],"securityGroupIngress":[{"sourceSecurityGroupId":{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]},"ipProtocol":"tcp","fromPort":2049,"toPort":2049,"description":"Allow NFS access from ECS tasks"},{"cidrIp":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VpcIPv4CIDR"},"ipProtocol":"tcp","fromPort":2049,"toPort":2049,"description":"Allow NFS access from VPC"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}},"EFS":{"id":"EFS","path":"TAK-Demo-AuthInfra/EFS/EFS","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.FileSystem","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EFS/EFS/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.CfnFileSystem","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EFS::FileSystem","aws:cdk:cloudformation:props":{"encrypted":true,"fileSystemPolicy":{"Statement":[{"Action":["elasticfilesystem:ClientMount","elasticfilesystem:ClientRootAccess","elasticfilesystem:ClientWrite"],"Condition":{"Bool":{"elasticfilesystem:AccessedViaMountTarget":"true"}},"Effect":"Allow","Principal":{"AWS":"*"}},{"Action":["elasticfilesystem:ClientRootAccess","elasticfilesystem:ClientWrite"],"Condition":{"Bool":{"elasticfilesystem:AccessedViaMountTarget":"true"}},"Effect":"Allow","Principal":{"AWS":"*"}}],"Version":"2012-10-17"},"kmsKeyId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"},"performanceMode":"generalPurpose","fileSystemTags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"},{"key":"Name","value":"TAK-Demo-AuthInfra/EFS/EFS"}],"throughputMode":"bursting"}}},"EfsMountTarget-PrivateSubnet1":{"id":"EfsMountTarget-PrivateSubnet1","path":"TAK-Demo-AuthInfra/EFS/EFS/EfsMountTarget-PrivateSubnet1","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.CfnMountTarget","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EFS::MountTarget","aws:cdk:cloudformation:props":{"fileSystemId":{"Ref":"EFSDBAB55BC"},"securityGroups":[{"Fn::GetAtt":["EFSEFSMountTargetSecurityGroup2BD329ED","GroupId"]}],"subnetId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"}}}},"EfsMountTarget-PrivateSubnet2":{"id":"EfsMountTarget-PrivateSubnet2","path":"TAK-Demo-AuthInfra/EFS/EFS/EfsMountTarget-PrivateSubnet2","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.CfnMountTarget","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EFS::MountTarget","aws:cdk:cloudformation:props":{"fileSystemId":{"Ref":"EFSDBAB55BC"},"securityGroups":[{"Fn::GetAtt":["EFSEFSMountTargetSecurityGroup2BD329ED","GroupId"]}],"subnetId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}}}}}},"EFSAccessPointMedia":{"id":"EFSAccessPointMedia","path":"TAK-Demo-AuthInfra/EFS/EFSAccessPointMedia","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.AccessPoint","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EFS/EFSAccessPointMedia/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.CfnAccessPoint","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EFS::AccessPoint","aws:cdk:cloudformation:props":{"fileSystemId":{"Ref":"EFSDBAB55BC"},"posixUser":{"uid":"1000","gid":"1000"},"rootDirectory":{"creationInfo":{"ownerGid":"1000","ownerUid":"1000","permissions":"755"},"path":"/media"},"accessPointTags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"},{"key":"Name","value":"TAK-Demo-AuthInfra/EFS/EFSAccessPointMedia"}]}}}}},"EFSAccessPointCustomTemplates":{"id":"EFSAccessPointCustomTemplates","path":"TAK-Demo-AuthInfra/EFS/EFSAccessPointCustomTemplates","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.AccessPoint","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EFS/EFSAccessPointCustomTemplates/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_efs.CfnAccessPoint","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EFS::AccessPoint","aws:cdk:cloudformation:props":{"fileSystemId":{"Ref":"EFSDBAB55BC"},"posixUser":{"uid":"1000","gid":"1000"},"rootDirectory":{"creationInfo":{"ownerGid":"1000","ownerUid":"1000","permissions":"755"},"path":"/custom-templates"},"accessPointTags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"},{"key":"Name","value":"TAK-Demo-AuthInfra/EFS/EFSAccessPointCustomTemplates"}]}}}}},"EFSFileSystemId":{"id":"EFSFileSystemId","path":"TAK-Demo-AuthInfra/EFS/EFSFileSystemId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"EFSMediaAccessPointId":{"id":"EFSMediaAccessPointId","path":"TAK-Demo-AuthInfra/EFS/EFSMediaAccessPointId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"EFSCustomTemplatesAccessPointId":{"id":"EFSCustomTemplatesAccessPointId","path":"TAK-Demo-AuthInfra/EFS/EFSCustomTemplatesAccessPointId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}}}},"EcrImageValidator":{"id":"EcrImageValidator","path":"TAK-Demo-AuthInfra/EcrImageValidator","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"CustomResourceRole":{"id":"CustomResourceRole","path":"TAK-Demo-AuthInfra/EcrImageValidator/CustomResourceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportCustomResourceRole":{"id":"ImportCustomResourceRole","path":"TAK-Demo-AuthInfra/EcrImageValidator/CustomResourceRole/ImportCustomResourceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EcrImageValidator/CustomResourceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"policies":[{"policyName":"ECRAccess","policyDocument":{"Statement":[{"Action":["ecr:DescribeImages","ecr:GetAuthorizationToken","ecr:ListImages"],"Effect":"Allow","Resource":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}},{"Action":"ecr:GetAuthorizationToken","Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"}}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"LogGroup":{"id":"LogGroup","path":"TAK-Demo-AuthInfra/EcrImageValidator/LogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EcrImageValidator/LogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":"/aws/lambda/ecr-image-validator-Demo","retentionInDays":7,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"ValidatorFunction":{"id":"ValidatorFunction","path":"TAK-Demo-AuthInfra/EcrImageValidator/ValidatorFunction","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EcrImageValidator/ValidatorFunction/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"\nimport json\nimport boto3\nimport urllib3\n\ndef handler(event, context):\n    print(f\"Event: {json.dumps(event)}\")\n    \n    ecr_client = boto3.client('ecr')\n    ecr_repository_arn = event['ResourceProperties']['EcrRepositoryArn']\n    required_tags = event['ResourceProperties']['RequiredTags']\n    \n    try:\n        if event['RequestType'] in ['Create', 'Update']:\n            print(f\"ECR Repository ARN: {ecr_repository_arn}\")\n            print(f\"Required tags: {required_tags}\")\n            \n            # Extract repository name from ARN at runtime\n            # ECR ARN format: arn:aws:ecr:region:account:repository/repository-name\n            if not ecr_repository_arn.startswith('arn:aws:ecr:') or 'repository/' not in ecr_repository_arn:\n                error_msg = f\"Invalid ECR repository ARN: {ecr_repository_arn}\"\n                print(f\"ERROR: {error_msg}\")\n                send_response(event, context, \"FAILED\", {\"Error\": error_msg})\n                return\n                \n            repository_name = ecr_repository_arn.split('/')[-1]\n            if not repository_name:\n                error_msg = f\"Could not extract repository name from ARN: {ecr_repository_arn}\"\n                print(f\"ERROR: {error_msg}\")\n                send_response(event, context, \"FAILED\", {\"Error\": error_msg})\n                return\n            \n            print(f\"Extracted repository name: {repository_name}\")\n            print(f\"Validating images in repository: {repository_name}\")\n            \n            # List all images in the repository\n            response = ecr_client.describe_images(repositoryName=repository_name)\n            \n            # Extract all available tags\n            available_tags = set()\n            for image in response.get('imageDetails', []):\n                for tag in image.get('imageTags', []):\n                    available_tags.add(tag)\n            \n            print(f\"Available tags: {list(available_tags)}\")\n            \n            # Check if all required tags are present\n            missing_tags = []\n            for required_tag in required_tags:\n                if required_tag not in available_tags:\n                    missing_tags.append(required_tag)\n            \n            if missing_tags:\n                error_msg = f\"Missing required ECR images in repository '{repository_name}': {missing_tags}. Available tags: {list(available_tags)}\"\n                print(f\"ERROR: {error_msg}\")\n                send_response(event, context, \"FAILED\", {\"Error\": error_msg})\n                return\n            \n            print(\"All required ECR images are available\")\n            send_response(event, context, \"SUCCESS\", {\"Message\": \"All required images validated successfully\"})\n            \n        elif event['RequestType'] == 'Delete':\n            print(\"Delete request - no validation needed\")\n            send_response(event, context, \"SUCCESS\", {\"Message\": \"Delete completed\"})\n            \n    except Exception as e:\n        error_msg = f\"Error validating ECR images: {str(e)}\"\n        print(f\"ERROR: {error_msg}\")\n        send_response(event, context, \"FAILED\", {\"Error\": error_msg})\n\ndef send_response(event, context, response_status, response_data):\n    response_url = event['ResponseURL']\n    \n    response_body = {\n        'Status': response_status,\n        'Reason': f'See the details in CloudWatch Log Stream: {context.log_stream_name}',\n        'PhysicalResourceId': context.log_stream_name,\n        'StackId': event['StackId'],\n        'RequestId': event['RequestId'],\n        'LogicalResourceId': event['LogicalResourceId'],\n        'Data': response_data\n    }\n    \n    json_response_body = json.dumps(response_body)\n    \n    headers = {\n        'content-type': '',\n        'content-length': str(len(json_response_body))\n    }\n    \n    http = urllib3.PoolManager()\n    try:\n        response = http.request('PUT', response_url, body=json_response_body, headers=headers)\n        print(f\"Status code: {response.status}\")\n    except Exception as e:\n        print(f\"send_response Error: {e}\")\n"},"environment":{"variables":{"LOG_LEVEL":"INFO"}},"handler":"index.handler","loggingConfig":{"logGroup":{"Ref":"EcrImageValidatorLogGroup392194FF"}},"role":{"Fn::GetAtt":["EcrImageValidatorCustomResourceRoleAEB8A72D","Arn"]},"runtime":"python3.11","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"timeout":300}}}}},"Provider":{"id":"Provider","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider","constructInfo":{"fqn":"aws-cdk-lib.custom_resources.Provider","version":"2.200.2"},"children":{"framework-onEvent":{"id":"framework-onEvent","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.200.2","metadata":[]},"children":{"ServiceRole":{"id":"ServiceRole","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":"lambda:InvokeFunction","Effect":"Allow","Resource":[{"Fn::GetAtt":["EcrImageValidatorValidatorFunction03EF9A98","Arn"]},{"Fn::Join":["",[{"Fn::GetAtt":["EcrImageValidatorValidatorFunction03EF9A98","Arn"]},":*"]]}]},{"Action":"lambda:GetFunction","Effect":"Allow","Resource":{"Fn::GetAtt":["EcrImageValidatorValidatorFunction03EF9A98","Arn"]}}],"Version":"2012-10-17"},"policyName":"EcrImageValidatorProviderframeworkonEventServiceRoleDefaultPolicy78F30C21","roles":[{"Ref":"EcrImageValidatorProviderframeworkonEventServiceRole55E53571"}]}}}}}}},"Code":{"id":"Code","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/Code","constructInfo":{"fqn":"aws-cdk-lib.aws_s3_assets.Asset","version":"2.200.2"},"children":{"Stage":{"id":"Stage","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/Code/Stage","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"2.200.2"}},"AssetBucket":{"id":"AssetBucket","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/Code/AssetBucket","constructInfo":{"fqn":"aws-cdk-lib.aws_s3.BucketBase","version":"2.200.2","metadata":[]}}}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/EcrImageValidator/Provider/framework-onEvent/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"s3Bucket":"cdk-hnb659fds-assets-814704514736-ap-southeast-2","s3Key":"bdc104ed9cab1b5b6421713c8155f0b753380595356f710400609664d3635eca.zip"},"description":"AWS CDK resource provider framework - onEvent (TAK-Demo-AuthInfra/EcrImageValidator/Provider)","environment":{"variables":{"USER_ON_EVENT_FUNCTION_ARN":{"Fn::GetAtt":["EcrImageValidatorValidatorFunction03EF9A98","Arn"]}}},"handler":"framework.onEvent","role":{"Fn::GetAtt":["EcrImageValidatorProviderframeworkonEventServiceRole55E53571","Arn"]},"runtime":"nodejs22.x","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"timeout":900}}}}}}},"ImageValidation":{"id":"ImageValidation","path":"TAK-Demo-AuthInfra/EcrImageValidator/ImageValidation","constructInfo":{"fqn":"aws-cdk-lib.CustomResource","version":"2.200.2","metadata":[]},"children":{"Default":{"id":"Default","path":"TAK-Demo-AuthInfra/EcrImageValidator/ImageValidation/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.200.2"}}}}}},"AuthentikELB":{"id":"AuthentikELB","path":"TAK-Demo-AuthInfra/AuthentikELB","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"ALB":{"id":"ALB","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.ApplicationLoadBalancer","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnLoadBalancer","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::LoadBalancer","aws:cdk:cloudformation:props":{"ipAddressType":"dualstack","loadBalancerAttributes":[{"key":"deletion_protection.enabled","value":"false"}],"scheme":"internet-facing","securityGroups":[{"Fn::GetAtt":["AuthentikELBALBSecurityGroup6E7316BD","GroupId"]}],"subnets":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPublicA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPublicB"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"type":"application"}}},"SecurityGroup":{"id":"SecurityGroup","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/SecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/SecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Automatically created Security Group for ELB TAKDemoAuthInfraAuthentikELBALBA0BE8DAB","securityGroupIngress":[{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":80,"toPort":80,"description":"Allow from anyone on port 80"},{"cidrIpv6":"::/0","ipProtocol":"tcp","fromPort":80,"toPort":80,"description":"Allow from anyone on port 80"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":443,"toPort":443,"description":"Allow from anyone on port 443"},{"cidrIpv6":"::/0","ipProtocol":"tcp","fromPort":443,"toPort":443,"description":"Allow from anyone on port 443"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}},"to TAKDemoAuthInfraECSSecurityGroup1CACD961:9000":{"id":"to TAKDemoAuthInfraECSSecurityGroup1CACD961:9000","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/SecurityGroup/to TAKDemoAuthInfraECSSecurityGroup1CACD961:9000","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroupEgress","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroupEgress","aws:cdk:cloudformation:props":{"description":"Load balancer to target","destinationSecurityGroupId":{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]},"fromPort":9000,"groupId":{"Fn::GetAtt":["AuthentikELBALBSecurityGroup6E7316BD","GroupId"]},"ipProtocol":"tcp","toPort":9000}}}}},"HttpListener":{"id":"HttpListener","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/HttpListener","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.ApplicationListener","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/HttpListener/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnListener","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::Listener","aws:cdk:cloudformation:props":{"defaultActions":[{"type":"redirect","redirectConfig":{"statusCode":"HTTP_302","port":"443","protocol":"HTTPS"}}],"loadBalancerArn":{"Ref":"AuthentikELBALB795C77FA"},"port":80,"protocol":"HTTP"}}}}},"HttpsListener":{"id":"HttpsListener","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/HttpsListener","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.ApplicationListener","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikELB/ALB/HttpsListener/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnListener","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::Listener","aws:cdk:cloudformation:props":{"certificates":[{"certificateArn":{"Fn::ImportValue":"TAK-Demo-BaseInfra-AcmCert-ARN"}}],"defaultActions":[{"type":"forward","targetGroupArn":{"Ref":"AuthentikServerTargetGroup2D78069F"}}],"loadBalancerArn":{"Ref":"AuthentikELBALB795C77FA"},"port":443,"protocol":"HTTPS"}}}}}}},"LoadBalancerDnsName":{"id":"LoadBalancerDnsName","path":"TAK-Demo-AuthInfra/AuthentikELB/LoadBalancerDnsName","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikURL":{"id":"AuthentikURL","path":"TAK-Demo-AuthInfra/AuthentikELB/AuthentikURL","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}}}},"AuthentikServer":{"id":"AuthentikServer","path":"TAK-Demo-AuthInfra/AuthentikServer","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"ServerLogs":{"id":"ServerLogs","path":"TAK-Demo-AuthInfra/AuthentikServer/ServerLogs","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/ServerLogs/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":"AuthentikServer-server","retentionInDays":7,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"TaskExecutionRole":{"id":"TaskExecutionRole","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskExecutionRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportTaskExecutionRole":{"id":"ImportTaskExecutionRole","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskExecutionRole/ImportTaskExecutionRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskExecutionRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"]]}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskExecutionRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskExecutionRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["secretsmanager:DescribeSecret","secretsmanager:GetSecretValue"],"Effect":"Allow","Resource":[{"Ref":"DatabaseDBMasterSecret1B2A26AA"},{"Ref":"RedisRedisAuthTokenAC379C8C"},{"Ref":"SecretsManagerAuthentikAdminUserPassword3A38D3BB"},{"Ref":"SecretsManagerAuthentikAdminUserToken3137C5E0"},{"Ref":"SecretsManagerAuthentikSecretKey0C8A38C9"}]},{"Action":"kms:Decrypt","Effect":"Allow","Resource":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"}},{"Action":["s3:GetBucket*","s3:GetObject*","s3:List*"],"Effect":"Allow","Resource":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},{"Fn::Join":["",[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},"/*"]]}]},{"Action":["logs:CreateLogStream","logs:PutLogEvents"],"Effect":"Allow","Resource":{"Fn::GetAtt":["AuthentikServerServerLogs74B503FB","Arn"]}}],"Version":"2012-10-17"},"policyName":"AuthentikServerTaskExecutionRoleDefaultPolicyA31D2C97","roles":[{"Ref":"AuthentikServerTaskExecutionRole4B2763D5"}]}}}}}}},"TaskRole":{"id":"TaskRole","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportTaskRole":{"id":"ImportTaskRole","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskRole/ImportTaskRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["elasticfilesystem:ClientMount","elasticfilesystem:ClientRootAccess","elasticfilesystem:ClientWrite","elasticfilesystem:DescribeFileSystems","elasticfilesystem:DescribeMountTargets"],"Effect":"Allow","Resource":[{"Fn::Join":["",["arn:aws:elasticfilesystem:ap-southeast-2:814704514736:access-point/",{"Ref":"EFSEFSAccessPointCustomTemplatesC823127C"}]]},{"Fn::Join":["",["arn:aws:elasticfilesystem:ap-southeast-2:814704514736:access-point/",{"Ref":"EFSEFSAccessPointMedia865844DD"}]]},{"Fn::Join":["",["arn:aws:elasticfilesystem:ap-southeast-2:814704514736:file-system/",{"Ref":"EFSDBAB55BC"}]]}]},{"Action":["s3:GetBucket*","s3:GetObject*","s3:List*"],"Effect":"Allow","Resource":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},{"Fn::Join":["",[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},"/*"]]}]}],"Version":"2012-10-17"},"policyName":"AuthentikServerTaskRoleDefaultPolicy3082757F","roles":[{"Ref":"AuthentikServerTaskRole8D82523E"}]}}}}}}},"TaskDef":{"id":"TaskDef","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskDef","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.FargateTaskDefinition","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskDef/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.CfnTaskDefinition","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::TaskDefinition","aws:cdk:cloudformation:props":{"containerDefinitions":[{"command":["server"],"essential":true,"image":{"Fn::Join":["",[{"Fn::Sub":["${Account}.dkr.ecr.${Region}.amazonaws.com/${RepoName}",{"Account":{"Fn::Select":[4,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]},"Region":{"Fn::Select":[3,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]},"RepoName":{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::Select":[5,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]}]}]}}]},":auth-infra-server-3afd0ff270324ef49901108df31c4990fe138966"]]},"mountPoints":[{"containerPath":"/media","readOnly":false,"sourceVolume":"media"},{"containerPath":"/templates","readOnly":false,"sourceVolume":"custom-templates"}],"name":"AuthentikServer","portMappings":[{"containerPort":9000,"hostPort":9000,"protocol":"tcp"}],"logConfiguration":{"logDriver":"awslogs","options":{"awslogs-group":{"Ref":"AuthentikServerServerLogs74B503FB"},"awslogs-stream-prefix":"authentik-server","awslogs-region":"ap-southeast-2"}},"environment":[{"name":"AUTHENTIK_POSTGRESQL__HOST","value":{"Fn::GetAtt":["DatabaseDBCluster27FBE994","Endpoint.Address"]}},{"name":"AUTHENTIK_POSTGRESQL__USER","value":"authentik"},{"name":"AUTHENTIK_REDIS__HOST","value":{"Fn::GetAtt":["Redis04B3B4F3","PrimaryEndPoint.Address"]}},{"name":"AUTHENTIK_REDIS__TLS","value":"True"},{"name":"AUTHENTIK_REDIS__TLS_REQS","value":"required"}],"secrets":[{"name":"AUTHENTIK_POSTGRESQL__PASSWORD","valueFrom":{"Fn::Join":["",[{"Ref":"DatabaseDBMasterSecret1B2A26AA"},":password::"]]}},{"name":"AUTHENTIK_REDIS__PASSWORD","valueFrom":{"Ref":"RedisRedisAuthTokenAC379C8C"}},{"name":"AUTHENTIK_SECRET_KEY","valueFrom":{"Ref":"SecretsManagerAuthentikSecretKey0C8A38C9"}}],"healthCheck":{"command":["CMD","ak","healthcheck"],"interval":30,"retries":3,"startPeriod":60,"timeout":5}}],"cpu":"512","executionRoleArn":{"Fn::GetAtt":["AuthentikServerTaskExecutionRole4B2763D5","Arn"]},"family":"TAKDemoAuthInfraAuthentikServerTaskDef56E5EBFA","memory":"1024","networkMode":"awsvpc","requiresCompatibilities":["FARGATE"],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"taskRoleArn":{"Fn::GetAtt":["AuthentikServerTaskRole8D82523E","Arn"]},"volumes":[{"name":"media","efsVolumeConfiguration":{"filesystemId":{"Ref":"EFSDBAB55BC"},"authorizationConfig":{"accessPointId":{"Ref":"EFSEFSAccessPointMedia865844DD"},"iam":"ENABLED"},"transitEncryption":"ENABLED"}},{"name":"custom-templates","efsVolumeConfiguration":{"filesystemId":{"Ref":"EFSDBAB55BC"},"authorizationConfig":{"accessPointId":{"Ref":"EFSEFSAccessPointCustomTemplatesC823127C"},"iam":"ENABLED"},"transitEncryption":"ENABLED"}}]}}},"AuthentikServer":{"id":"AuthentikServer","path":"TAK-Demo-AuthInfra/AuthentikServer/TaskDef/AuthentikServer","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.ContainerDefinition","version":"2.200.2"}}}},"Service":{"id":"Service","path":"TAK-Demo-AuthInfra/AuthentikServer/Service","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.FargateService","version":"2.200.2","metadata":[]},"children":{"Service":{"id":"Service","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/Service","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.CfnService","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::Service","aws:cdk:cloudformation:props":{"cluster":{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecs-ARN"}]}]},"deploymentConfiguration":{"maximumPercent":200,"minimumHealthyPercent":50,"alarms":{"alarmNames":[],"enable":false,"rollback":false}},"desiredCount":1,"enableEcsManagedTags":false,"enableExecuteCommand":false,"healthCheckGracePeriodSeconds":300,"launchType":"FARGATE","loadBalancers":[{"targetGroupArn":{"Ref":"AuthentikServerTargetGroup2D78069F"},"containerName":"AuthentikServer","containerPort":9000}],"networkConfiguration":{"awsvpcConfiguration":{"assignPublicIp":"DISABLED","subnets":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}],"securityGroups":[{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]}]}},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"taskDefinition":{"Ref":"AuthentikServerTaskDef53A507A1"}}}},"ScalingRole":{"id":"ScalingRole","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/ScalingRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"TaskCount":{"id":"TaskCount","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/TaskCount","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.ScalableTaskCount","version":"2.200.2"},"children":{"Target":{"id":"Target","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/TaskCount/Target","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.ScalableTarget","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/TaskCount/Target/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.CfnScalableTarget","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ApplicationAutoScaling::ScalableTarget","aws:cdk:cloudformation:props":{"maxCapacity":3,"minCapacity":1,"resourceId":{"Fn::Join":["",["service/",{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecs-ARN"}]}]},"/",{"Fn::GetAtt":["AuthentikServerService3D748704","Name"]}]]},"roleArn":"arn:aws:iam::814704514736:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService","scalableDimension":"ecs:service:DesiredCount","serviceNamespace":"ecs"}}},"CpuScaling":{"id":"CpuScaling","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/TaskCount/Target/CpuScaling","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.TargetTrackingScalingPolicy","version":"2.200.2"},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/Service/TaskCount/Target/CpuScaling/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.CfnScalingPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ApplicationAutoScaling::ScalingPolicy","aws:cdk:cloudformation:props":{"policyName":"TAKDemoAuthInfraAuthentikServerServiceTaskCountTargetCpuScaling215D9D3E","policyType":"TargetTrackingScaling","scalingTargetId":{"Ref":"AuthentikServerServiceTaskCountTargetB025BF2D"},"targetTrackingScalingPolicyConfiguration":{"predefinedMetricSpecification":{"predefinedMetricType":"ECSServiceAverageCPUUtilization"},"scaleInCooldown":180,"scaleOutCooldown":60,"targetValue":70}}}}}}}}}}}},"TargetGroup":{"id":"TargetGroup","path":"TAK-Demo-AuthInfra/AuthentikServer/TargetGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.ApplicationTargetGroup","version":"2.200.2"},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikServer/TargetGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnTargetGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::TargetGroup","aws:cdk:cloudformation:props":{"healthCheckIntervalSeconds":30,"healthCheckPath":"/-/health/live/","matcher":{"httpCode":"200-299"},"port":9000,"protocol":"HTTP","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"targetGroupAttributes":[{"key":"stickiness.enabled","value":"false"}],"targetType":"ip","vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}}}},"AuthentikWorker":{"id":"AuthentikWorker","path":"TAK-Demo-AuthInfra/AuthentikWorker","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"WorkerLogs":{"id":"WorkerLogs","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerLogs","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerLogs/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":"AuthentikWorker-worker","retentionInDays":7,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"WorkerTaskExecutionRole":{"id":"WorkerTaskExecutionRole","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskExecutionRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportWorkerTaskExecutionRole":{"id":"ImportWorkerTaskExecutionRole","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskExecutionRole/ImportWorkerTaskExecutionRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskExecutionRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"]]}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskExecutionRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskExecutionRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["secretsmanager:DescribeSecret","secretsmanager:GetSecretValue"],"Effect":"Allow","Resource":[{"Ref":"DatabaseDBMasterSecret1B2A26AA"},{"Ref":"RedisRedisAuthTokenAC379C8C"},{"Ref":"SecretsManagerAuthentikAdminUserPassword3A38D3BB"},{"Ref":"SecretsManagerAuthentikAdminUserToken3137C5E0"},{"Ref":"SecretsManagerAuthentikLDAPServiceUser8290CA7A"},{"Ref":"SecretsManagerAuthentikSecretKey0C8A38C9"}]},{"Action":"kms:Decrypt","Effect":"Allow","Resource":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"}},{"Action":["s3:GetBucket*","s3:GetObject*","s3:List*"],"Effect":"Allow","Resource":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},{"Fn::Join":["",[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},"/*"]]}]},{"Action":["logs:CreateLogStream","logs:PutLogEvents"],"Effect":"Allow","Resource":{"Fn::GetAtt":["AuthentikWorkerWorkerLogs4F6481FA","Arn"]}}],"Version":"2012-10-17"},"policyName":"AuthentikWorkerWorkerTaskExecutionRoleDefaultPolicy871BA571","roles":[{"Ref":"AuthentikWorkerWorkerTaskExecutionRoleDBD72B08"}]}}}}}}},"WorkerTaskRole":{"id":"WorkerTaskRole","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportWorkerTaskRole":{"id":"ImportWorkerTaskRole","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskRole/ImportWorkerTaskRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["elasticfilesystem:ClientMount","elasticfilesystem:ClientRootAccess","elasticfilesystem:ClientWrite","elasticfilesystem:DescribeFileSystems","elasticfilesystem:DescribeMountTargets"],"Effect":"Allow","Resource":[{"Fn::Join":["",["arn:aws:elasticfilesystem:ap-southeast-2:814704514736:access-point/",{"Ref":"EFSEFSAccessPointCustomTemplatesC823127C"}]]},{"Fn::Join":["",["arn:aws:elasticfilesystem:ap-southeast-2:814704514736:access-point/",{"Ref":"EFSEFSAccessPointMedia865844DD"}]]},{"Fn::Join":["",["arn:aws:elasticfilesystem:ap-southeast-2:814704514736:file-system/",{"Ref":"EFSDBAB55BC"}]]}]},{"Action":["s3:GetBucket*","s3:GetObject*","s3:List*"],"Effect":"Allow","Resource":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},{"Fn::Join":["",[{"Fn::ImportValue":"TAK-Demo-BaseInfra-S3ConfBucket-ARN"},"/*"]]}]}],"Version":"2012-10-17"},"policyName":"AuthentikWorkerWorkerTaskRoleDefaultPolicy1D0D1DC0","roles":[{"Ref":"AuthentikWorkerWorkerTaskRole17674E05"}]}}}}}}},"WorkerTaskDef":{"id":"WorkerTaskDef","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskDef","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.FargateTaskDefinition","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskDef/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.CfnTaskDefinition","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::TaskDefinition","aws:cdk:cloudformation:props":{"containerDefinitions":[{"command":["worker"],"essential":true,"image":{"Fn::Join":["",[{"Fn::Sub":["${Account}.dkr.ecr.${Region}.amazonaws.com/${RepoName}",{"Account":{"Fn::Select":[4,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]},"Region":{"Fn::Select":[3,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]},"RepoName":{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::Select":[5,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]}]}]}}]},":auth-infra-server-3afd0ff270324ef49901108df31c4990fe138966"]]},"mountPoints":[{"containerPath":"/media","readOnly":false,"sourceVolume":"media"},{"containerPath":"/templates","readOnly":false,"sourceVolume":"custom-templates"}],"name":"AuthentikWorker","logConfiguration":{"logDriver":"awslogs","options":{"awslogs-group":{"Ref":"AuthentikWorkerWorkerLogs4F6481FA"},"awslogs-stream-prefix":"authentik-worker","awslogs-region":"ap-southeast-2"}},"environment":[{"name":"AUTHENTIK_POSTGRESQL__HOST","value":{"Fn::GetAtt":["DatabaseDBCluster27FBE994","Endpoint.Address"]}},{"name":"AUTHENTIK_POSTGRESQL__USER","value":"authentik"},{"name":"AUTHENTIK_REDIS__HOST","value":{"Fn::GetAtt":["Redis04B3B4F3","PrimaryEndPoint.Address"]}},{"name":"AUTHENTIK_REDIS__TLS","value":"True"},{"name":"AUTHENTIK_REDIS__TLS_REQS","value":"required"},{"name":"AUTHENTIK_BOOTSTRAP_EMAIL","value":"admin@tak.nz"},{"name":"AUTHENTIK_BOOTSTRAP_LDAP_BASEDN","value":"dc=example,dc=com"},{"name":"AUTHENTIK_BOOTSTRAP_LDAP_AUTHENTIK_HOST","value":{"Fn::Join":["",["https://account.",{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}]]}}],"secrets":[{"name":"AUTHENTIK_POSTGRESQL__PASSWORD","valueFrom":{"Fn::Join":["",[{"Ref":"DatabaseDBMasterSecret1B2A26AA"},":password::"]]}},{"name":"AUTHENTIK_REDIS__PASSWORD","valueFrom":{"Ref":"RedisRedisAuthTokenAC379C8C"}},{"name":"AUTHENTIK_SECRET_KEY","valueFrom":{"Ref":"SecretsManagerAuthentikSecretKey0C8A38C9"}},{"name":"AUTHENTIK_BOOTSTRAP_LDAPSERVICE_USERNAME","valueFrom":{"Fn::Join":["",[{"Ref":"SecretsManagerAuthentikLDAPServiceUser8290CA7A"},":username::"]]}},{"name":"AUTHENTIK_BOOTSTRAP_LDAPSERVICE_PASSWORD","valueFrom":{"Fn::Join":["",[{"Ref":"SecretsManagerAuthentikLDAPServiceUser8290CA7A"},":password::"]]}},{"name":"AUTHENTIK_BOOTSTRAP_PASSWORD","valueFrom":{"Fn::Join":["",[{"Ref":"SecretsManagerAuthentikAdminUserPassword3A38D3BB"},":password::"]]}},{"name":"AUTHENTIK_BOOTSTRAP_TOKEN","valueFrom":{"Ref":"SecretsManagerAuthentikAdminUserToken3137C5E0"}}],"healthCheck":{"command":["CMD","ak","healthcheck"],"interval":30,"retries":3,"startPeriod":60,"timeout":30}}],"cpu":"512","executionRoleArn":{"Fn::GetAtt":["AuthentikWorkerWorkerTaskExecutionRoleDBD72B08","Arn"]},"family":"TAKDemoAuthInfraAuthentikWorkerWorkerTaskDef60DD808A","memory":"1024","networkMode":"awsvpc","requiresCompatibilities":["FARGATE"],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"taskRoleArn":{"Fn::GetAtt":["AuthentikWorkerWorkerTaskRole17674E05","Arn"]},"volumes":[{"name":"media","efsVolumeConfiguration":{"filesystemId":{"Ref":"EFSDBAB55BC"},"authorizationConfig":{"accessPointId":{"Ref":"EFSEFSAccessPointMedia865844DD"},"iam":"ENABLED"},"transitEncryption":"ENABLED"}},{"name":"custom-templates","efsVolumeConfiguration":{"filesystemId":{"Ref":"EFSDBAB55BC"},"authorizationConfig":{"accessPointId":{"Ref":"EFSEFSAccessPointCustomTemplatesC823127C"},"iam":"ENABLED"},"transitEncryption":"ENABLED"}}]}}},"AuthentikWorker":{"id":"AuthentikWorker","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerTaskDef/AuthentikWorker","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.ContainerDefinition","version":"2.200.2"}}}},"WorkerService":{"id":"WorkerService","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.FargateService","version":"2.200.2","metadata":[]},"children":{"Service":{"id":"Service","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/Service","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.CfnService","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::Service","aws:cdk:cloudformation:props":{"cluster":{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecs-ARN"}]}]},"deploymentConfiguration":{"maximumPercent":200,"minimumHealthyPercent":50,"alarms":{"alarmNames":[],"enable":false,"rollback":false}},"desiredCount":1,"enableEcsManagedTags":false,"enableExecuteCommand":false,"launchType":"FARGATE","networkConfiguration":{"awsvpcConfiguration":{"assignPublicIp":"DISABLED","subnets":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}],"securityGroups":[{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]}]}},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"taskDefinition":{"Ref":"AuthentikWorkerWorkerTaskDefBAB02C6B"}}}},"ScalingRole":{"id":"ScalingRole","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/ScalingRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"TaskCount":{"id":"TaskCount","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/TaskCount","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.ScalableTaskCount","version":"2.200.2"},"children":{"Target":{"id":"Target","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/TaskCount/Target","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.ScalableTarget","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/TaskCount/Target/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.CfnScalableTarget","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ApplicationAutoScaling::ScalableTarget","aws:cdk:cloudformation:props":{"maxCapacity":2,"minCapacity":1,"resourceId":{"Fn::Join":["",["service/",{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecs-ARN"}]}]},"/",{"Fn::GetAtt":["AuthentikWorkerWorkerService38766934","Name"]}]]},"roleArn":"arn:aws:iam::814704514736:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService","scalableDimension":"ecs:service:DesiredCount","serviceNamespace":"ecs"}}},"WorkerCpuScaling":{"id":"WorkerCpuScaling","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/TaskCount/Target/WorkerCpuScaling","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.TargetTrackingScalingPolicy","version":"2.200.2"},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/AuthentikWorker/WorkerService/TaskCount/Target/WorkerCpuScaling/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_applicationautoscaling.CfnScalingPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ApplicationAutoScaling::ScalingPolicy","aws:cdk:cloudformation:props":{"policyName":"TAKDemoAuthInfraAuthentikWorkerWorkerServiceTaskCountTargetWorkerCpuScalingE7A0E427","policyType":"TargetTrackingScaling","scalingTargetId":{"Ref":"AuthentikWorkerWorkerServiceTaskCountTarget4D58E899"},"targetTrackingScalingPolicyConfiguration":{"predefinedMetricSpecification":{"predefinedMetricType":"ECSServiceAverageCPUUtilization"},"scaleInCooldown":300,"scaleOutCooldown":120,"targetValue":80}}}}}}}}}}}}}},"Route53Authentik":{"id":"Route53Authentik","path":"TAK-Demo-AuthInfra/Route53Authentik","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"HostedZone":{"id":"HostedZone","path":"TAK-Demo-AuthInfra/Route53Authentik/HostedZone","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"AuthentikARecord":{"id":"AuthentikARecord","path":"TAK-Demo-AuthInfra/Route53Authentik/AuthentikARecord","constructInfo":{"fqn":"aws-cdk-lib.aws_route53.ARecord","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Route53Authentik/AuthentikARecord/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_route53.CfnRecordSet","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Route53::RecordSet","aws:cdk:cloudformation:props":{"aliasTarget":{"hostedZoneId":{"Fn::GetAtt":["AuthentikELBALB795C77FA","CanonicalHostedZoneID"]},"dnsName":{"Fn::Join":["",["dualstack.",{"Fn::GetAtt":["AuthentikELBALB795C77FA","DNSName"]}]]}},"comment":"Authentik IPv4 alias record for Demo environment","hostedZoneId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-ID"},"name":{"Fn::Join":["",["account.",{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"},"."]]},"type":"A"}}}}},"AuthentikAAAARecord":{"id":"AuthentikAAAARecord","path":"TAK-Demo-AuthInfra/Route53Authentik/AuthentikAAAARecord","constructInfo":{"fqn":"aws-cdk-lib.aws_route53.AaaaRecord","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Route53Authentik/AuthentikAAAARecord/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_route53.CfnRecordSet","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Route53::RecordSet","aws:cdk:cloudformation:props":{"aliasTarget":{"hostedZoneId":{"Fn::GetAtt":["AuthentikELBALB795C77FA","CanonicalHostedZoneID"]},"dnsName":{"Fn::Join":["",["dualstack.",{"Fn::GetAtt":["AuthentikELBALB795C77FA","DNSName"]}]]}},"comment":"Authentik IPv6 alias record for Demo environment","hostedZoneId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-ID"},"name":{"Fn::Join":["",["account.",{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"},"."]]},"type":"AAAA"}}}}}}},"LdapTokenRetriever":{"id":"LdapTokenRetriever","path":"TAK-Demo-AuthInfra/LdapTokenRetriever","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"LogGroup":{"id":"LogGroup","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/LogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/LogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":"/aws/lambda/TAK-Demo-AuthInfra-update-ldap-token","retentionInDays":7,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"LambdaRole":{"id":"LambdaRole","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/LambdaRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportLambdaRole":{"id":"ImportLambdaRole","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/LambdaRole/ImportLambdaRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/LambdaRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"policies":[{"policyName":"SecretsManagerAccess","policyDocument":{"Statement":[{"Action":["secretsmanager:GetSecretValue","secretsmanager:PutSecretValue","secretsmanager:UpdateSecret"],"Effect":"Allow","Resource":["arn:aws:secretsmanager:ap-southeast-2:814704514736:secret:Demo/authentik-admin-token*","arn:aws:secretsmanager:ap-southeast-2:814704514736:secret:Demo/authentik-ldap-token*","arn:aws:secretsmanager:ap-southeast-2:814704514736:secret:coe-auth-*",{"Ref":"SecretsManagerAuthentikAdminUserToken3137C5E0"},{"Ref":"SecretsManagerAuthentikLDAPToken690C2508"}]},{"Action":["kms:Decrypt","kms:DescribeKey","kms:Encrypt","kms:GenerateDataKey","kms:GenerateDataKeyWithoutPlaintext","kms:ReEncryptFrom","kms:ReEncryptTo"],"Effect":"Allow","Resource":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"}}],"Version":"2012-10-17"}}],"roleName":"TAK-Demo-AuthInfra-update-ldap-token-lambda-role","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"Function":{"id":"Function","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/Function","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/Function/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"\nconst { SecretsManagerClient, GetSecretValueCommand, PutSecretValueCommand } = require('@aws-sdk/client-secrets-manager');\nconst https = require('https');\nconst http = require('http');\nconst { URL } = require('url');\n\nconst secretsManager = new SecretsManagerClient({});\n\n// Helper function to send CloudFormation response\nasync function sendResponse(event, context, responseStatus, responseData = {}, physicalResourceId = null) {\n    const responseBody = JSON.stringify({\n        Status: responseStatus,\n        Reason: `See the details in CloudWatch Log Stream: ${context.logStreamName}`,\n        PhysicalResourceId: physicalResourceId || context.logStreamName,\n        StackId: event.StackId,\n        RequestId: event.RequestId,\n        LogicalResourceId: event.LogicalResourceId,\n        Data: responseData\n    });\n\n    const parsedUrl = new URL(event.ResponseURL);\n    const options = {\n        hostname: parsedUrl.hostname,\n        port: 443,\n        path: parsedUrl.pathname + parsedUrl.search,\n        method: 'PUT',\n        headers: {\n            'content-type': '',\n            'content-length': responseBody.length\n        }\n    };\n\n    return new Promise((resolve, reject) => {\n        const request = https.request(options, (response) => {\n            console.log(`Status code: ${response.statusCode}`);\n            resolve();\n        });\n        \n        request.on('error', (error) => {\n            console.log(`send(..) failed executing https.request(..):`, error);\n            reject(error);\n        });\n        \n        request.write(responseBody);\n        request.end();\n    });\n}\n\n// Helper function to fetch JSON data\nasync function fetchJson(url, options) {\n    return new Promise((resolve, reject) => {\n        const urlObj = new URL(url);\n        const lib = urlObj.protocol === 'https:' ? https : http;\n        \n        const req = lib.request(url, {\n            method: options.method || 'GET',\n            headers: options.headers || {}\n        }, (res) => {\n            let data = '';\n            res.on('data', chunk => data += chunk);\n            res.on('end', () => {\n                if (res.statusCode >= 200 && res.statusCode < 300) {\n                    try {\n                        resolve(JSON.parse(data));\n                    } catch (e) {\n                        reject(new Error(`Invalid JSON response: ${e.message}`));\n                    }\n                } else {\n                    reject(new Error(`HTTP error! status: ${res.statusCode}`));\n                }\n            });\n        });\n        \n        req.on('error', reject);\n        req.end();\n    });\n}\n\nasync function getAdminToken(adminSecretName) {\n    console.log('Getting admin token from secret:', adminSecretName);\n    \n    const command = new GetSecretValueCommand({\n        SecretId: adminSecretName\n    });\n    \n    const response = await secretsManager.send(command);\n    return response.SecretString;\n}\n\nasync function retrieveToken(authentikHost, authentikApiToken, outpostName) {\n    outpostName = outpostName || 'LDAP';\n    \n    try {\n        // Fetch outpost instances from API\n        const outpostInstancesUrl = new URL('/api/v3/outposts/instances/', authentikHost);\n        outpostInstancesUrl.searchParams.append('name__iexact', outpostName);\n\n        console.log('Fetching outpost instances from:', outpostInstancesUrl.toString());\n        \n        const outpostInstances = await fetchJson(outpostInstancesUrl.toString(), {\n            method: 'GET',\n            headers: {\n                'Accept': 'application/json',\n                'Authorization': `Bearer ${authentikApiToken}`\n            }\n        });\n\n        // Check if we found the outpost\n        const results = outpostInstances.results || [];\n        if (results.length === 0) {\n            throw new Error(`Outpost with name ${outpostName} not found, aborting...`);\n        }\n\n        // Extract the token identifier\n        const outpost = results.find((item) => item.name === outpostName);\n        if (!outpost || !outpost.token_identifier) {\n            throw new Error(`Token identifier for outpost ${outpostName} not found, aborting...`);\n        }\n\n        const tokenIdentifier = outpost.token_identifier;\n        console.log('Found token identifier:', tokenIdentifier);\n\n        // Fetch the token\n        const viewKeyUrl = new URL(`/api/v3/core/tokens/${tokenIdentifier}/view_key/`, authentikHost);\n\n        const viewKeyResult = await fetchJson(viewKeyUrl.toString(), {\n            method: 'GET',\n            headers: {\n                'Accept': 'application/json',\n                'Authorization': `Bearer ${authentikApiToken}`\n            }\n        });\n\n        const outpostToken = viewKeyResult.key;\n        if (!outpostToken) {\n            throw new Error(`Token for outpost ${outpostName} not found, aborting...`);\n        }\n\n        return outpostToken;\n    } catch (error) {\n        console.error(`Error retrieving token: ${error.message}`);\n        throw error;\n    }\n}\n\nasync function putLDAPSecret(secretName, secretValue) {\n    console.log('Updating LDAP token secret:', secretName);\n    \n    const command = new PutSecretValueCommand({\n        SecretId: secretName,\n        SecretString: secretValue\n    });\n    \n    try {\n        await secretsManager.send(command);\n        console.log('LDAP token secret updated successfully');\n    } catch (error) {\n        console.error('Error updating secret:', error);\n        throw error;\n    }\n}\n\nexports.handler = async (event, context) => {\n    console.log('Event:', JSON.stringify(event, null, 2));\n    \n    const { RequestType, ResourceProperties } = event;\n    const { \n        Environment, \n        AuthentikHost, \n        OutpostName,\n        AdminSecretName,\n        LDAPSecretName\n    } = ResourceProperties;\n    \n    try {\n        if (RequestType === 'Create' || RequestType === 'Update') {\n            console.log('Processing LDAP token retrieval...');\n            console.log('Environment:', Environment);\n            console.log('Authentik URL:', AuthentikHost);\n            console.log('Outpost Name:', OutpostName);\n            console.log('Admin Secret Name:', AdminSecretName);\n            console.log('LDAP Secret Name:', LDAPSecretName);\n            \n            // Get the admin token from AWS Secrets Manager\n            const adminToken = await getAdminToken(AdminSecretName);\n            \n            // Retrieve the LDAP token from Authentik\n            const ldapToken = await retrieveToken(AuthentikHost, adminToken, OutpostName);\n            \n            // Store the LDAP token back in AWS Secrets Manager\n            await putLDAPSecret(LDAPSecretName, ldapToken);\n            \n            await sendResponse(event, context, 'SUCCESS', {\n                Message: 'LDAP token retrieved and updated successfully',\n                LDAPToken: ldapToken.substring(0, 10) + '...' // Log only first 10 chars for security\n            });\n        } else if (RequestType === 'Delete') {\n            console.log('Delete request - no action needed for LDAP token retrieval');\n            await sendResponse(event, context, 'SUCCESS', {\n                Message: 'Delete completed'\n            });\n        }\n    } catch (error) {\n        console.error('Error:', error);\n        await sendResponse(event, context, 'FAILED', {\n            Message: error.message\n        });\n    }\n};\n      "},"environment":{"variables":{"NODE_OPTIONS":"--enable-source-maps"}},"functionName":"TAK-Demo-AuthInfra-update-ldap-token","handler":"index.handler","loggingConfig":{"logGroup":{"Ref":"LdapTokenRetrieverLogGroup67698D40"}},"role":{"Fn::GetAtt":["LdapTokenRetrieverLambdaRoleD2B26E17","Arn"]},"runtime":"nodejs22.x","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"timeout":300}}}}},"Provider":{"id":"Provider","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/Provider","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.FunctionBase","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/Resource","constructInfo":{"fqn":"aws-cdk-lib.CustomResource","version":"2.200.2","metadata":[]},"children":{"Default":{"id":"Default","path":"TAK-Demo-AuthInfra/LdapTokenRetriever/Resource/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.200.2"}}}}}},"LDAP":{"id":"LDAP","path":"TAK-Demo-AuthInfra/LDAP","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Logs":{"id":"Logs","path":"TAK-Demo-AuthInfra/LDAP/Logs","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/Logs/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":"LDAP","retentionInDays":7,"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"NLBSecurityGroup":{"id":"NLBSecurityGroup","path":"TAK-Demo-AuthInfra/LDAP/NLBSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/NLBSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Allow 389 and 636 Access to NLB","securityGroupEgress":[{"cidrIp":"255.255.255.255/32","description":"Disallow all traffic","ipProtocol":"icmp","fromPort":252,"toPort":86}],"securityGroupIngress":[{"cidrIp":"10.0.0.0/8","ipProtocol":"tcp","fromPort":389,"toPort":389,"description":"Allow LDAP access"},{"cidrIp":"10.0.0.0/8","ipProtocol":"tcp","fromPort":636,"toPort":636,"description":"Allow LDAPS access"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}},"NLB":{"id":"NLB","path":"TAK-Demo-AuthInfra/LDAP/NLB","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.NetworkLoadBalancer","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/NLB/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnLoadBalancer","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::LoadBalancer","aws:cdk:cloudformation:props":{"loadBalancerAttributes":[{"key":"deletion_protection.enabled","value":"false"}],"scheme":"internal","subnets":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"type":"network"}}},"LdapListener":{"id":"LdapListener","path":"TAK-Demo-AuthInfra/LDAP/NLB/LdapListener","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.NetworkListener","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/NLB/LdapListener/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnListener","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::Listener","aws:cdk:cloudformation:props":{"defaultActions":[{"type":"forward","targetGroupArn":{"Ref":"LDAPLdapTargetGroup1919E1F7"}}],"loadBalancerArn":{"Ref":"LDAPNLBBE603900"},"port":389,"protocol":"TCP"}}}}},"LdapsListener":{"id":"LdapsListener","path":"TAK-Demo-AuthInfra/LDAP/NLB/LdapsListener","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.NetworkListener","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/NLB/LdapsListener/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnListener","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::Listener","aws:cdk:cloudformation:props":{"certificates":[{"certificateArn":{"Fn::ImportValue":"TAK-Demo-BaseInfra-AcmCert-ARN"}}],"defaultActions":[{"type":"forward","targetGroupArn":{"Ref":"LDAPLdapsTargetGroup555B6A6F"}}],"loadBalancerArn":{"Ref":"LDAPNLBBE603900"},"port":636,"protocol":"TLS"}}}}}}},"TaskExecutionRole":{"id":"TaskExecutionRole","path":"TAK-Demo-AuthInfra/LDAP/TaskExecutionRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportTaskExecutionRole":{"id":"ImportTaskExecutionRole","path":"TAK-Demo-AuthInfra/LDAP/TaskExecutionRole/ImportTaskExecutionRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/TaskExecutionRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"]]}],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"TAK-Demo-AuthInfra/LDAP/TaskExecutionRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/TaskExecutionRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["secretsmanager:DescribeSecret","secretsmanager:GetSecretValue"],"Effect":"Allow","Resource":{"Ref":"SecretsManagerAuthentikLDAPToken690C2508"}},{"Action":"kms:Decrypt","Effect":"Allow","Resource":{"Fn::ImportValue":"TAK-Demo-BaseInfra-Kms-ARN"}},{"Action":["logs:CreateLogStream","logs:PutLogEvents"],"Effect":"Allow","Resource":{"Fn::GetAtt":["LDAPLogsA8A4E865","Arn"]}}],"Version":"2012-10-17"},"policyName":"LDAPTaskExecutionRoleDefaultPolicyCF95384E","roles":[{"Ref":"LDAPTaskExecutionRole6EF84A89"}]}}}}}}},"TaskRole":{"id":"TaskRole","path":"TAK-Demo-AuthInfra/LDAP/TaskRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.2","metadata":[]},"children":{"ImportTaskRole":{"id":"ImportTaskRole","path":"TAK-Demo-AuthInfra/LDAP/TaskRole/ImportTaskRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/TaskRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}]}}}}},"TaskDef":{"id":"TaskDef","path":"TAK-Demo-AuthInfra/LDAP/TaskDef","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.FargateTaskDefinition","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/TaskDef/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.CfnTaskDefinition","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::TaskDefinition","aws:cdk:cloudformation:props":{"containerDefinitions":[{"essential":true,"image":{"Fn::Join":["",[{"Fn::Sub":["${Account}.dkr.ecr.${Region}.amazonaws.com/${RepoName}",{"Account":{"Fn::Select":[4,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]},"Region":{"Fn::Select":[3,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]},"RepoName":{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::Select":[5,{"Fn::Split":[":",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecr-ARN"}]}]}]}]}}]},":auth-infra-ldap-3afd0ff270324ef49901108df31c4990fe138966"]]},"name":"AuthentikLdap","portMappings":[{"containerPort":3389,"hostPort":3389,"protocol":"tcp"},{"containerPort":6636,"hostPort":6636,"protocol":"tcp"}],"logConfiguration":{"logDriver":"awslogs","options":{"awslogs-group":{"Ref":"LDAPLogsA8A4E865"},"awslogs-stream-prefix":"authentik-ldap","awslogs-region":"ap-southeast-2"}},"environment":[{"name":"AUTHENTIK_HOST","value":{"Fn::Join":["",["https://account.",{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"},"/"]]}},{"name":"AUTHENTIK_INSECURE","value":"false"}],"secrets":[{"name":"AUTHENTIK_TOKEN","valueFrom":{"Ref":"SecretsManagerAuthentikLDAPToken690C2508"}}]}],"cpu":"512","executionRoleArn":{"Fn::GetAtt":["LDAPTaskExecutionRole6EF84A89","Arn"]},"family":"TAKDemoAuthInfraLDAPTaskDefBAF99ACC","memory":"1024","networkMode":"awsvpc","requiresCompatibilities":["FARGATE"],"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"taskRoleArn":{"Fn::GetAtt":["LDAPTaskRoleB3995714","Arn"]}}}},"AuthentikLdap":{"id":"AuthentikLdap","path":"TAK-Demo-AuthInfra/LDAP/TaskDef/AuthentikLdap","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.ContainerDefinition","version":"2.200.2"}}}},"Service":{"id":"Service","path":"TAK-Demo-AuthInfra/LDAP/Service","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.FargateService","version":"2.200.2","metadata":[]},"children":{"Service":{"id":"Service","path":"TAK-Demo-AuthInfra/LDAP/Service/Service","constructInfo":{"fqn":"aws-cdk-lib.aws_ecs.CfnService","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::Service","aws:cdk:cloudformation:props":{"cluster":{"Fn::Select":[1,{"Fn::Split":["/",{"Fn::ImportValue":"TAK-Demo-BaseInfra-Ecs-ARN"}]}]},"deploymentConfiguration":{"maximumPercent":200,"minimumHealthyPercent":50,"deploymentCircuitBreaker":{"enable":true,"rollback":true},"alarms":{"alarmNames":[],"enable":false,"rollback":false}},"desiredCount":1,"enableEcsManagedTags":false,"enableExecuteCommand":false,"healthCheckGracePeriodSeconds":60,"launchType":"FARGATE","loadBalancers":[{"targetGroupArn":{"Ref":"LDAPLdapTargetGroup1919E1F7"},"containerName":"AuthentikLdap","containerPort":3389},{"targetGroupArn":{"Ref":"LDAPLdapsTargetGroup555B6A6F"},"containerName":"AuthentikLdap","containerPort":3389}],"networkConfiguration":{"awsvpcConfiguration":{"assignPublicIp":"DISABLED","subnets":[{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateA"},{"Fn::ImportValue":"TAK-Demo-BaseInfra-SubnetPrivateB"}],"securityGroups":[{"Fn::GetAtt":["ECSSecurityGroupA14DBE7D","GroupId"]}]}},"tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"taskDefinition":{"Ref":"LDAPTaskDef6D68C93C"}}}}}},"LdapTargetGroup":{"id":"LdapTargetGroup","path":"TAK-Demo-AuthInfra/LDAP/LdapTargetGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.NetworkTargetGroup","version":"2.200.2"},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/LdapTargetGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnTargetGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::TargetGroup","aws:cdk:cloudformation:props":{"healthCheckIntervalSeconds":30,"healthCheckPort":"3389","healthCheckProtocol":"TCP","port":3389,"protocol":"TCP","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"targetType":"ip","vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}},"LdapsTargetGroup":{"id":"LdapsTargetGroup","path":"TAK-Demo-AuthInfra/LDAP/LdapsTargetGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.NetworkTargetGroup","version":"2.200.2"},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/LDAP/LdapsTargetGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_elasticloadbalancingv2.CfnTargetGroup","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::ElasticLoadBalancingV2::TargetGroup","aws:cdk:cloudformation:props":{"healthCheckIntervalSeconds":30,"healthCheckPort":"6636","healthCheckProtocol":"TCP","port":6636,"protocol":"TCP","tags":[{"key":"DNS Zone","value":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"}},{"key":"Environment Type","value":"Dev-Test"}],"targetType":"ip","vpcId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-VPC-ID"}}}}}},"LoadBalancerDnsName":{"id":"LoadBalancerDnsName","path":"TAK-Demo-AuthInfra/LDAP/LoadBalancerDnsName","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"LdapEndpoint":{"id":"LdapEndpoint","path":"TAK-Demo-AuthInfra/LDAP/LdapEndpoint","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"LdapsEndpoint":{"id":"LdapsEndpoint","path":"TAK-Demo-AuthInfra/LDAP/LdapsEndpoint","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}}}},"Route53":{"id":"Route53","path":"TAK-Demo-AuthInfra/Route53","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"HostedZone":{"id":"HostedZone","path":"TAK-Demo-AuthInfra/Route53/HostedZone","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.2","metadata":[]}},"LdapARecord":{"id":"LdapARecord","path":"TAK-Demo-AuthInfra/Route53/LdapARecord","constructInfo":{"fqn":"aws-cdk-lib.aws_route53.ARecord","version":"2.200.2","metadata":[]},"children":{"Resource":{"id":"Resource","path":"TAK-Demo-AuthInfra/Route53/LdapARecord/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_route53.CfnRecordSet","version":"2.200.2"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Route53::RecordSet","aws:cdk:cloudformation:props":{"aliasTarget":{"hostedZoneId":{"Fn::GetAtt":["LDAPNLBBE603900","CanonicalHostedZoneID"]},"dnsName":{"Fn::Join":["",["dualstack.",{"Fn::GetAtt":["LDAPNLBBE603900","DNSName"]}]]}},"comment":"LDAP IPv4 alias record for Demo environment","hostedZoneId":{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-ID"},"name":{"Fn::Join":["",["ldap.",{"Fn::ImportValue":"TAK-Demo-BaseInfra-R53Zone-Name"},"."]]},"type":"A"}}}}}}},"DatabaseEndpointOutput":{"id":"DatabaseEndpointOutput","path":"TAK-Demo-AuthInfra/DatabaseEndpointOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"DatabaseSecretArnOutput":{"id":"DatabaseSecretArnOutput","path":"TAK-Demo-AuthInfra/DatabaseSecretArnOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"RedisEndpointOutput":{"id":"RedisEndpointOutput","path":"TAK-Demo-AuthInfra/RedisEndpointOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"RedisAuthTokenArnOutput":{"id":"RedisAuthTokenArnOutput","path":"TAK-Demo-AuthInfra/RedisAuthTokenArnOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"EfsIdOutput":{"id":"EfsIdOutput","path":"TAK-Demo-AuthInfra/EfsIdOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"EfsMediaAccessPointOutput":{"id":"EfsMediaAccessPointOutput","path":"TAK-Demo-AuthInfra/EfsMediaAccessPointOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"EfsTemplatesAccessPointOutput":{"id":"EfsTemplatesAccessPointOutput","path":"TAK-Demo-AuthInfra/EfsTemplatesAccessPointOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikSecretKeyArnOutput":{"id":"AuthentikSecretKeyArnOutput","path":"TAK-Demo-AuthInfra/AuthentikSecretKeyArnOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikAdminTokenArnOutput":{"id":"AuthentikAdminTokenArnOutput","path":"TAK-Demo-AuthInfra/AuthentikAdminTokenArnOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikLdapTokenArnOutput":{"id":"AuthentikLdapTokenArnOutput","path":"TAK-Demo-AuthInfra/AuthentikLdapTokenArnOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikAlbDnsOutput":{"id":"AuthentikAlbDnsOutput","path":"TAK-Demo-AuthInfra/AuthentikAlbDnsOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"AuthentikUrlOutput":{"id":"AuthentikUrlOutput","path":"TAK-Demo-AuthInfra/AuthentikUrlOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"LdapNlbDnsOutput":{"id":"LdapNlbDnsOutput","path":"TAK-Demo-AuthInfra/LdapNlbDnsOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"LdapTokenRetrieverLambdaArnOutput":{"id":"LdapTokenRetrieverLambdaArnOutput","path":"TAK-Demo-AuthInfra/LdapTokenRetrieverLambdaArnOutput","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.200.2"}},"CDKMetadata":{"id":"CDKMetadata","path":"TAK-Demo-AuthInfra/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Default":{"id":"Default","path":"TAK-Demo-AuthInfra/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.200.2"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"TAK-Demo-AuthInfra/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.200.2"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"TAK-Demo-AuthInfra/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.200.2"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}}}}