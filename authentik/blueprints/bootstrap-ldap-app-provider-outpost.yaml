version: 1
metadata:
  name: LDAP application, provider & outpost
  labels:
    blueprints.goauthentik.io/system-bootstrap: "true"
    blueprints.goauthentik.io/description: |
      This blueprint creates an LDAP application, provider and outpost.
context:
  basedn: !Env [AUTHENTIK_BOOTSTRAP_LDAP_BASEDN, "DC=example,DC=com"]
  username: !Env [AUTHENTIK_BOOTSTRAP_LDAPSERVICE_USERNAME, "ldapservice"]
entries:
  - model: authentik_providers_ldap.ldapprovider
    id: provider
    identifiers:
      name: LDAP
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
      base_dn: !Context basedn
      bind_mode: cached
      gid_start_number: 4000
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      mfa_support: true
      name: Provider for LDAP
      search_mode: cached
      uid_start_number: 2000
    permissions:
      - permission: search_full_directory
        user: !Find [authentik_core.user, [username, ldapservice]]
  - model: authentik_core.application
    id: app
    identifiers:
      slug: ldap
    attrs:
      name: LDAP
      policy_engine_mode: any
      provider: !KeyOf provider
  - model: authentik_outposts.outpost  
    id: outpost
    identifiers:
      name: LDAP
    attrs:
      config:
        authentik_host: 'http://localhost:9000/'
      providers:
      - !KeyOf provider
      type: ldap
  
  
    
      
    

  - model: authentik_core.user
    state: created
    id: ak-outpost-ldap
    identifiers:
      username: ak-outpost-ldap
    attrs:
      name: Outpost LDAP Service-Account
      type: internal_service_account
      path: goauthentik.io/outposts
      password: null


  - 
    authorization_flow: ldap-authentication-flow
    
    

  

- attrs:
    authorization_flow: !Find [authentik_flows.flow, [slug, default-password-change]]
    base_dn: DC=tak,DC=nz
    bind_mode: cached
    gid_start_number: 4000
    invalidation_flow: 7804a536-b7c9-4ed0-9a28-5545bfde246f
    mfa_support: true
    name: Provider for LDAP
    search_mode: cached
    uid_start_number: 2000
  model: authentik_providers_ldap.ldapprovider
  